---
layout: post
image: assets/images/system-design/escalabilidade-capa.png
author: matheus
featured: false
published: true
categories: [ system-design, engineering, cloud ]
title: System Design - Cache
---

# Definindo Cache

# Principios Básicos de Cache

# Implementações de Cache 

## Cache em Memória (Hashmap)

```go

```

## Cache de Conteúdo

```go
const origem = "https://google.com.br"
const cacheDir = "./cache"
const port = 8080

// Função que cria um hash da URL
func generateHash(input string) string {
	hash := sha1.New()
	hash.Write([]byte(input))
	return hex.EncodeToString(hash.Sum(nil))
}

func ProxyCacheHandler(w http.ResponseWriter, r *http.Request) {

	var body []byte

	// Tempo inicial da requisição
	startTime := time.Now()

	// Define o diretório do cache do recurso calculando a hash da URL
	cachePath := filepath.Join(cacheDir, generateHash(r.URL.Path))

	// Verifica se o recurso está em cache
	_, err := os.Stat(cachePath)

	// Caso não esteja, recupera o recurso do servidor
	if os.IsNotExist(err) {
		fmt.Println("Recurso não está presente em cache, buscando na origem:", r.URL.Path)

		// Constroi a URL do recurso
		url := fmt.Sprintf("%s%s", origem, r.URL.Path)

		// Realiza a requisição para a origem para buscar o recurso
		resp, err := http.Get(url)
		if err != nil {
			http.Error(w, "Server Error", http.StatusInternalServerError)
			log.Println("Falha ao buscar o recurso na origem:", err)
			return
		}
		defer resp.Body.Close()

		// Lê o conteúdo da resposta
		body, err = ioutil.ReadAll(resp.Body)
		if err != nil {
			http.Error(w, "Server Error", http.StatusInternalServerError)
			log.Println("Falha ao ler a resposta do servidor:", err)
			return
		}

		// Salva o arquivo em cache com o conteúdo do recurso
		ioutil.WriteFile(cachePath, body, 0644)
	} else {
		// Caso esteja em cache, lê o arquivo e retorna no response
		fmt.Println("Recurso está presente em cache:", r.URL.Path, cachePath)

		// Lê o arquivo em cache
		body, err = ioutil.ReadFile(cachePath)
		if err != nil {
			http.Error(w, "Server Error", http.StatusInternalServerError)
			log.Println("Falha ao ler o cache:", err)
			return
		}
	}

	// Tempo total da requisição
	fmt.Println(fmt.Sprintf("Tempo total da requisição para o recurso %v:  %v", r.URL.Path, time.Since(startTime)))

	// Resposta cacheada da requisição
	w.Write(body)

}

func main() {

	// Cria o diretório de armazenamento do cache
	fmt.Println("Criando diretório de cache:", cacheDir)
	if _, err := os.Stat(cacheDir); os.IsNotExist(err) {
		os.Mkdir(cacheDir, os.ModePerm)
	}

	// Cria um server HTTP simples para fazer handling dos requests
	fmt.Println("Iniciando Proxy para a origem:", origem)
	http.HandleFunc("/", ProxyCacheHandler)

	fmt.Println("Proxy iniciado na porta:", port)
	log.Fatal(http.ListenAndServe(fmt.Sprintf(":%v", port), nil))
}
```

```
Criando diretório de cache: ./cache
Iniciando Proxy para a origem: https://google.com.br
Proxy iniciado na porta: 8080
Recurso não está presente em cache, buscando na origem: /
Tempo total da requisição para o recurso /:  795.700625ms
Recurso não está presente em cache, buscando na origem: /client_204
Recurso não está presente em cache, buscando na origem: /images/branding/googlelogo/1x/googlelogo_white_background_color_272x92dp.png
Recurso não está presente em cache, buscando na origem: /textinputassistant/tia.png
Recurso não está presente em cache, buscando na origem: /images/nav_logo229.png
Recurso não está presente em cache, buscando na origem: /xjs/_/js/k=xjs.hp.en.v2grbV-lSNQ.O/am=AAAAAAAAAAAAAAAAAAAAAAAAAAACAAAAAAA4AAAAAiAAAAAABgAAAAAAAAACABxERwAwAEcAAHgB/d=1/ed=1/rs=ACT90oES1zvGValamnA-977V6dGcCu-eaQ/m=sb_he,d
Tempo total da requisição para o recurso /xjs/_/js/k=xjs.hp.en.v2grbV-lSNQ.O/am=AAAAAAAAAAAAAAAAAAAAAAAAAAACAAAAAAA4AAAAAiAAAAAABgAAAAAAAAACABxERwAwAEcAAHgB/d=1/ed=1/rs=ACT90oES1zvGValamnA-977V6dGcCu-eaQ/m=sb_he,d:  107.101708ms
Tempo total da requisição para o recurso /textinputassistant/tia.png:  132.588208ms
Tempo total da requisição para o recurso /images/branding/googlelogo/1x/googlelogo_white_background_color_272x92dp.png:  132.977041ms
Tempo total da requisição para o recurso /images/nav_logo229.png:  130.294708ms
Tempo total da requisição para o recurso /client_204:  211.213916ms
Recurso está presente em cache: /images/nav_logo229.png cache/d99d33e5ee22dee6f248b342095f1382cc3a9580
Tempo total da requisição para o recurso /images/nav_logo229.png:  411.792µs
Recurso não está presente em cache, buscando na origem: /gen_204
Tempo total da requisição para o recurso /gen_204:  179.880792ms
```

```
Recurso está presente em cache: / cache/42099b4af021e53fd8fd4e056c2568d7c2e3ffa8
Tempo total da requisição para o recurso /:  357.791µs
Recurso está presente em cache: /images/branding/googlelogo/1x/googlelogo_white_background_color_272x92dp.png cache/ffa840af19c091b0e9304cae9327510f5c5c6e0d
Tempo total da requisição para o recurso /images/branding/googlelogo/1x/googlelogo_white_background_color_272x92dp.png:  306.625µs
Recurso está presente em cache: /textinputassistant/tia.png cache/d61ec3ad1d7c3687061c89561ac34d4a40659823
Tempo total da requisição para o recurso /textinputassistant/tia.png:  1.7355ms
Recurso está presente em cache: /xjs/_/js/k=xjs.hp.en.v2grbV-lSNQ.O/am=AAAAAAAAAAAAAAAAAAAAAAAAAAACAAAAAAA4AAAAAiAAAAAABgAAAAAAAAACABxERwAwAEcAAHgB/d=1/ed=1/rs=ACT90oES1zvGValamnA-977V6dGcCu-eaQ/m=sb_he,d cache/0590c87359355c9a948ac0829a030a371e46d959
Tempo total da requisição para o recurso /xjs/_/js/k=xjs.hp.en.v2grbV-lSNQ.O/am=AAAAAAAAAAAAAAAAAAAAAAAAAAACAAAAAAA4AAAAAiAAAAAABgAAAAAAAAACABxERwAwAEcAAHgB/d=1/ed=1/rs=ACT90oES1zvGValamnA-977V6dGcCu-eaQ/m=sb_he,d:  676.375µs
Recurso está presente em cache: /images/nav_logo229.png cache/d99d33e5ee22dee6f248b342095f1382cc3a9580
Tempo total da requisição para o recurso /images/nav_logo229.png:  103.5µs
Recurso está presente em cache: /client_204 cache/9036ec3b37560314f1df05b153d3486ae6a8f808
Tempo total da requisição para o recurso /client_204:  87.375µs
Recurso está presente em cache: /images/nav_logo229.png cache/d99d33e5ee22dee6f248b342095f1382cc3a9580
Tempo total da requisição para o recurso /images/nav_logo229.png:  112.833µs
Recurso está presente em cache: /gen_204 cache/b55d8b2989794808c756b64e38355d9a0920bd30
Tempo total da requisição para o recurso /gen_204:  118.541µs
```

## Estratégias de Caching

### Cache e Camadas de Dados

### Cache e Consistência de Dados

### Caching em Sistemas Distribuídos

### Cache em Memória (In-Memory Cache)

### Cache em Disco (Disk Cache)

### Cache Distribuído

### Cache de Conteúdo Distribuído (CDN Cache)

### Cache de Aplicação (Application Cache)

