<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<link rel="icon" href="/assets/images/logo.png">

<title>Provisionando um cluster de EKS sem Node Groups com Karpenter | Matheus Fidelis</title>

<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Provisionando um cluster de EKS sem Node Groups com Karpenter | Matheus Fidelis - Engineering Blog</title>
<meta name="generator" content="Jekyll v4.3.2" />
<meta property="og:title" content="Provisionando um cluster de EKS sem Node Groups com Karpenter" />
<meta name="author" content="matheus" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="A proposta dessa PoC é criar e gerenciar um cluster de EKS utilizando apenas (ou quase) o Karpenter como provisionamento de recursos computacionais pro Workload produtivo, tirando a necessidade de Node Groups e Auto Scale Groups. Trazendo todo o gerenciamento de recursos pra dentro de CRD’s do Karpenter." />
<meta property="og:description" content="A proposta dessa PoC é criar e gerenciar um cluster de EKS utilizando apenas (ou quase) o Karpenter como provisionamento de recursos computacionais pro Workload produtivo, tirando a necessidade de Node Groups e Auto Scale Groups. Trazendo todo o gerenciamento de recursos pra dentro de CRD’s do Karpenter." />
<link rel="canonical" href="https://medium.com/@fidelissauro/provisionando-um-cluster-de-eks-sem-node-groups-com-karpenter-4d302b32b620?source=rss-fc2fda5e9bc2------2" />
<meta property="og:url" content="https://medium.com/@fidelissauro/provisionando-um-cluster-de-eks-sem-node-groups-com-karpenter-4d302b32b620?source=rss-fc2fda5e9bc2------2" />
<meta property="og:site_name" content="Matheus Fidelis - Engineering Blog" />
<meta property="og:image" content="http://localhost:4000/assets/images/karpenter-node-groups.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-08-05T00:00:00-03:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="http://localhost:4000/assets/images/karpenter-node-groups.png" />
<meta property="twitter:title" content="Provisionando um cluster de EKS sem Node Groups com Karpenter" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"matheus"},"dateModified":"2022-08-05T00:00:00-03:00","datePublished":"2022-08-05T00:00:00-03:00","description":"A proposta dessa PoC é criar e gerenciar um cluster de EKS utilizando apenas (ou quase) o Karpenter como provisionamento de recursos computacionais pro Workload produtivo, tirando a necessidade de Node Groups e Auto Scale Groups. Trazendo todo o gerenciamento de recursos pra dentro de CRD’s do Karpenter.","headline":"Provisionando um cluster de EKS sem Node Groups com Karpenter","image":"http://localhost:4000/assets/images/karpenter-node-groups.png","mainEntityOfPage":{"@type":"WebPage","@id":"https://medium.com/@fidelissauro/provisionando-um-cluster-de-eks-sem-node-groups-com-karpenter-4d302b32b620?source=rss-fc2fda5e9bc2------2"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://localhost:4000/assets/images/logo.png"},"name":"matheus"},"url":"https://medium.com/@fidelissauro/provisionando-um-cluster-de-eks-sem-node-groups-com-karpenter-4d302b32b620?source=rss-fc2fda5e9bc2------2"}</script>
<!-- End Jekyll SEO tag -->


<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    
<link href="/assets/css/screen.css" rel="stylesheet">

<link href="/assets/css/main.css" rel="stylesheet">

<script src="/assets/js/jquery.min.js"></script>

</head>




<body class="layout-post">
	<!-- defer loading of font and font awesome -->
	<noscript id="deferred-styles">
		<link href="https://fonts.googleapis.com/css?family=Righteous%7CMerriweather:300,300i,400,400i,700,700i" rel="stylesheet">
		<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">
	</noscript>


<!-- Begin Menu Navigation
================================================== -->
<nav class="navbar navbar-expand-lg navbar-light bg-white fixed-top mediumnavigation nav-down">

    <div class="container pr-0">

    <!-- Begin Logo -->
    <a class="navbar-brand" href="/">
    <img src="/assets/images/logo.png" alt="Matheus Fidelis">
    </a>
    <!-- End Logo -->

    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarMediumish" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarMediumish">

        <!-- Begin Menu -->

            <ul class="navbar-nav ml-auto">

                
                <li class="nav-item">
                
                <a class="nav-link" href="/index.html">Blog</a>
                </li>

                <li class="nav-item">
                <a class="nav-link" href="/about">Sobre</a>
                </li>

                <li class="nav-item">
                    <a class="nav-link" target=”_blank” href="/feed.xml">RSS</a>
                </li>

                <li class="nav-item">
                    <a class="nav-link" target=”_blank” href="https://fidelissauro.substack.com/">Newsletter</a>
                </li>

                <script src="/assets/js/lunr.js"></script>


<style>
    .lunrsearchresult .title {color: #d9230f;}
    .lunrsearchresult .url {color: silver;}
    .lunrsearchresult a {display: block; color: #777;}
    .lunrsearchresult a:hover, .lunrsearchresult a:focus {text-decoration: none;}
    .lunrsearchresult a:hover .title {text-decoration: underline;}
</style>


<form class="bd-search" onSubmit="return lunr_search(document.getElementById('lunrsearch').value);">
    <input type="text" class="form-control text-small launch-modal-search" id="lunrsearch" name="q" maxlength="255" value="" placeholder="Type and enter..."/>
</form>

<div id="lunrsearchresults">
    <ul></ul>
</div>

<script src="/assets/js/lunrsearchengine.js"></script>

            </ul>

        <!-- End Menu -->

    </div>

    </div>
</nav>
<!-- End Navigation
================================================== -->

<div class="site-content">

<div class="container">

<!-- Site Title
================================================== -->
<div class="mainheading">
    <h1 class="sitetitle">Matheus Fidelis</h1>
    <p class="lead">
        Technical Blog
    </p>
</div>

<!-- Content
================================================== -->
<div class="main-content">
    <!-- Begin Article
================================================== -->
<div class="container">
    <div class="row">

        <!-- Post Share -->
        <div class="col-md-2 pl-0">
            <div class="share sticky-top sticky-top-offset">
    <p>
        Share
    </p>
    <ul>
        <li class="ml-1 mr-1">
            <a target="_blank" href="https://twitter.com/intent/tweet?text=Provisionando um cluster de EKS sem Node Groups com Karpenter&url=http://localhost:4000/provisionando-um-cluster-de-eks-sem-node-groups-com-karpenter/" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                <i class="fab fa-twitter"></i>
            </a>
        </li>

        <li class="ml-1 mr-1">
            <a target="_blank" href="https://facebook.com/sharer.php?u=http://localhost:4000/provisionando-um-cluster-de-eks-sem-node-groups-com-karpenter/" onclick="window.open(this.href, 'facebook-share', 'width=550,height=435');return false;">
                <i class="fab fa-facebook-f"></i>
            </a>
        </li>

        <li class="ml-1 mr-1">
            <a target="_blank" href="https://www.linkedin.com/shareArticle?mini=true&url=http://localhost:4000/provisionando-um-cluster-de-eks-sem-node-groups-com-karpenter/" onclick="window.open(this.href, 'width=550,height=435');return false;">
                <i class="fab fa-linkedin-in"></i>
            </a>
        </li>

    </ul>
    
    <div class="sep">
    </div>
    <ul>
        <li>
        <a class="small smoothscroll" href="#disqus_thread"></a>
        </li>
    </ul>
    
</div>

        </div>

        <!-- Post -->
        

        <div class="col-md-9 flex-first flex-md-unordered">
            <div class="mainheading">

                <!-- Author Box -->
                
                <div class="row post-top-meta">
                    <div class="col-xs-12 col-md-3 col-lg-2 text-center text-md-left mb-4 mb-md-0">
                        
                        <img class="author-thumb" src="https://www.gravatar.com/avatar/5700ede08434f0ab49b75fe5543f129b?s=250&d=mm&r=x" alt="Matheus Fidelis">
                        
                    </div>
                    <div class="col-xs-12 col-md-9 col-lg-10 text-center text-md-left">
                        <a target="_blank" class="link-dark" href="https://msfidelis.github.io/">Matheus Fidelis</a><a target="_blank" href="https://twitter.com/fidelissauro" class="btn follow">Follow</a>
                        <span class="author-description">Staff Engineer, Lifelong Learner, Site Reliability Engineer, Cloud and Containers Wizard, Software Alchemist and Home Bartender</span>
                    </div>
                </div>
                

                <!-- Post Title -->
                <h1 class="posttitle">Provisionando um cluster de EKS sem Node Groups com Karpenter</h1>

            </div>

            <!-- Adsense if enabled from _config.yml (change your pub id and slot) -->
            
            <!-- End Adsense -->

            <!-- Post Featured Image -->
            

            
            <img class="featured-image img-fluid lazyimg" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAMAAAACCAQAAAA3fa6RAAAADklEQVR42mNkAANGCAUAACMAA2w/AMgAAAAASUVORK5CYII=" data-src="/assets/images/karpenter-node-groups.png" alt="Provisionando um cluster de EKS sem Node Groups com Karpenter">
            

            
            <!-- End Featured Image -->

            <!-- Post Content -->
            <div class="article-post">
                <!-- Toc if any -->
                
                <!-- End Toc -->
                <p><em>A proposta dessa PoC é criar e gerenciar um cluster de EKS utilizando apenas (ou quase) o <strong>Karpenter</strong> como provisionamento de recursos computacionais pro Workload produtivo, tirando a necessidade de Node Groups e Auto Scale Groups.</em> Trazendo todo o gerenciamento de recursos pra dentro de CRD’s do <strong>Karpenter</strong>.</p>

<p><strong>Nesse cenário vamos assumir algumas premissas importantes:</strong></p>

<ul>
  <li>O objetivo do <strong>Karpenter</strong> como tecnologia é prover um “just in time” scale, o que faz dele uma proposta interessante para workloads que tenham picos de acesso, processamentos agendados mais pesados e tenham um delta de escalabilidade computacional mais agressivos.</li>
  <li>Essa proposta é excelente para muitos casos de uso, mas também é preciso assumir que gera uma volatilidade muito brusca na quantidade de nós e pods. Por isso é ideal que as aplicações e suas dependências estejam preparadas para morrer com segurança e aumentar ou diminuir o consumo de recursos na mesma proporção.</li>
  <li>Como um cluster de Kubernetes é composto por várias “pecinhas de lego” muito importantes, e que muitas vezes não estão preparadas para lidar com essa volatilidade agressiva para qual essa PoC está sendo desenhada, o modo mais intuitivo que trouxe para resolver esse cenário foi colocar os namespaces de serviço, como <strong>prometheus</strong>, kube-system e outras aplicações “satélites” em nodes Fargate, para que eles sejam poupados dessas mudanças bruscas de capacity.</li>
</ul>

<p><br></p>

<h1 id="provisionamento">Provisionamento</h1>

<p>Vou omitir bastante detalhes do código como um todo para não transformar esse artigo numa bíblia, mas fique tranquilo que todo o desenvolvimento está sendo documentado <a href="https://github.com/msfidelis/eks-karpenter-autonomous-cluster">neste repositório do GitHub</a>.</p>

<p><br></p>

<h2 id="roles-de-iam">Roles de IAM</h2>

<p>Antes de qualquer coisa vamos precisar provisionar uma série de roles com as permissões necessárias para o provisionamento dos recursos e configurações dos componentes. Como qualquer cluster de Kubernetes vamos precisar providenciar com antecedência 3 tipos de roles. Uma para o Control Plane, outra que será usada como Instance Profile para as instâncias dos Nodes e outra para os Fargate Profiles.</p>

<h4 id="roles-de-iamcluster">Roles de IAM — Cluster</h4>

<p>Iniciando pela role do Control Plane precisamos associar 2 managed policies, <strong>AmazonEKSClusterPolicy</strong> e <strong>AmazonEKSServicePolicy</strong>.</p>

<noscript><pre>400: Invalid request</pre></noscript>
<script src="https://gist.github.com/6bcc50e984845bc4231b4a894484705d.js"> </script>

<p><br></p>

<h4 id="roles-de-iamnodes--instance-profile">Roles de IAM — Nodes / Instance Profile</h4>

<p>O provisionamento da Instance Profile dos nodes também não muda caso você fosse usar com Node Groups, com exceção de que vamos precisar criar a instance profile propriamente dita. Quando utilizamos Node Groups o próprio serviço do EKS se encarrega de fazer a criação desse recurso caso não exista previamente. Mas é simples.</p>

<p>Vamos precisar associar algumas Managed Policies padrão também para funcionar. Mas sem segredo de outros tipos de provisionamento.</p>

<noscript><pre>400: Invalid request</pre></noscript>
<script src="https://gist.github.com/c9aeff3c103d324508aadcb5acf175aa.js"> </script>

<p>Vamos criar uma associação de instance profile na role criada para os nodes para posteriormente criamos o Launch Configuration com ela.</p>

<noscript><pre>400: Invalid request</pre></noscript>
<script src="https://gist.github.com/496af72dba1c7bee474b254d6ec4be0b.js"> </script>

<p><br></p>

<h4 id="roles-de-iamfargate-profiles">Roles de IAM — Fargate Profiles</h4>

<p>O provisionamento da role dos Fargate Profiles também é padrão. Escrevendo esse artigo me vem aquela sensação de “pow, essas roles já poderiam existir na conta por default né? Chatão”. Pois é.</p>

<p>Funciona no mesmo esquema das anteriores, precisamos anexar algumas managed policies padrão para que o serviço funcione.</p>

<noscript><pre>400: Invalid request</pre></noscript>
<script src="https://gist.github.com/ec44c3b441302e2cf0d67e415a13f103.js"> </script>

<p><br></p>

<h2 id="eks-cluster">EKS Cluster</h2>

<p>O provisionamento do cluster foi feito sem a base de um modulo ou facilitador. Até mesmo porque não seria interessante provisionar nada além do próprio control plane do EKS para PoC nesse primeiro momento.</p>

<p>Vamos utilizar o recurso base do <strong>aws_eks_cluster</strong> nos atentando as tags de discovery do Karpenter que precisam estar presentes.</p>

<noscript><pre>400: Invalid request</pre></noscript>
<script src="https://gist.github.com/1dfab0ee9ac6cc62fd0c60d482e83b47.js"> </script>

<p><br></p>

<h2 id="fargate-profilekube-system">Fargate Profile — Kube System</h2>

<p>Como dito anteriormente nas premissas da PoC, tudo que se encaixar como um componente sistêmico do funcionamento da plataforma, e não como parte do workload será provisionado em <strong><em>Fargate Profiles</em></strong> para poupá-los da volatilidade de scale in / scale out que iremos trazer para o cluster com o Karpenter. Dito isso, vamos provisionar o fargate profile para o namespace do <strong><em>kube-system</em></strong>.</p>

<noscript><pre>400: Invalid request</pre></noscript>
<script src="https://gist.github.com/a52e4ef23209e91fee7d8e7b9e5bc82b.js"> </script>

<p><br></p>

<h2 id="coredns-fixworkaround">CoreDNS Fix — Workaround</h2>

<p>Uma das coisas mais chatas e sem sentido do uso de cluster Full Fargate é a limitação do <strong><em>CoreDNS</em></strong> de subir naturalmente em nodes que não sejam EC2 efetivamente. Até a data desse artigo, é necessário utilizar de algum artificio automatizado ou manual para remover a label de <strong><em>eks.amazonaws.com/compute-type</em></strong> de ec2 para que ele consiga ser provisonado em nodes fargate.</p>

<p>Você pode fazer isso manualmente sem problemas diretamente com o kubectl.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>kubectl patch deployment coredns <span class="nt">-n</span> kube-system <span class="nt">--type</span> json <span class="nt">-p</span><span class="o">=</span><span class="s1">'[{"op": "remove", "path": "/spec/template/metadata/annotations/eks.amazonaws.com~1compute-type"}]'</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><em>Porém como preguiça pouca é besteira</em>, eu vou utilizar uma lambda que após o provisionamento do cluster se encarrega de remover essa label através da API do control plane.</p>

<p>Peguei a base inicial dessa lambda através do artigo <a href="https://docs.aws.amazon.com/prescriptive-guidance/latest/patterns/deploy-coredns-on-amazon-eks-with-fargate-automatically-using-terraform-and-python">Deploy CoreDNS on Amazon EKS with Fargate automatically using Terraform and Python</a> escrito por <strong>Kevin Vaughan</strong> e <strong>Lorenzo Couto</strong> da AWS. Porém fiz algumas modificações de <em>stepback</em> e <em>retry</em> para realização dessa configuração porque algumas vezes falhava nas primeiras tentativas pela API não estar tão disponível quanto deveria.</p>

<p>O provisionamento dela está em um repositório de exemplo separado para ajudar em casos isolados e também futuramente transformar em módulo que resolve esse problema. <em>Dor de cabeça pro Matheus do futuro</em>.</p>

<p>No caso no Terraform iremos empacotar o script normalmente e criar a lambda na VPC que entregamos o cluster.</p>

<noscript><pre>400: Invalid request</pre></noscript>
<script src="https://gist.github.com/d82bc4d1c33c8d0033046d02725bc31a.js"> </script>

<p>Nenhuma trigger é necessária para esse primeiro momento. Ao invés disso na pipeline vamos chamar um <strong><em>aws_lambda_invocation</em></strong> passando o <em>endpoint</em> do cluster e um <em>token</em> temporário que será utilizado para fazer o request com o Patch removendo a label. Isso irá forçar um redeploy do coreDNS, porém fazendo ele subir em nodes fargate com o planejado na própria execução da pipeline. Ganhando bastante tempo e diminuindo “gols de mão” do processo.</p>

<noscript><pre>400: Invalid request</pre></noscript>
<script src="https://gist.github.com/3d97ca827575c52cd0cd68fb0c9db3e9.js"> </script>

<p><a href="https://github.com/msfidelis/eks-coredns-fargate-fix">GitHub - msfidelis/eks-coredns-fargate-fix: Lambda setup to fix CoreDNS deployments to run on Fargate Clusters</a></p>

<p><br></p>

<h2 id="provisionamento-do-karpenter">Provisionamento do Karpenter</h2>

<p>O provisionamento do Karpenter com Terraform e Helm não tem segredo. Exemplo foi adaptado direto da excelente documentação do projeto. São passos bem semelhantes dos que vimos até agora. Onde será necessário providenciar uma Role para o serviço com um assume role federado para o OIDC do cluster (exemplo completo no repositório).</p>

<p><br></p>

<h4 id="iam-role">IAM Role</h4>

<p>A role do karpenter precisa ter algumas permissões bem semelhantes ao Cluster Autoscaler caso você já tenha utilizado. Ele precisa de algumas permissões de controle de EC2 para poder lançar e deletar elas sob demanda. Sem segredo por aqui.</p>

<noscript><pre>400: Invalid request</pre></noscript>
<script src="https://gist.github.com/ebcc3ea5a2e13d30f31567ce9cef9e7c.js"> </script>

<p><br></p>

<h4 id="karpenterfargate">Karpenter — Fargate</h4>

<p>Segundo passo é colocar o Karpenter para rodar em Fargate Profile semelhante como fizemos com o <strong><em>kube-system</em></strong>, para impedir de que um <em>drain</em> de nodes afete o próprio karpenter e dê algum problema no processo de uma forma geral. Então, seguindo a premissa de que se não é workload, está seguro em fargate, vamos subir ele também.</p>

<noscript><pre>400: Invalid request</pre></noscript>
<script src="https://gist.github.com/3d4fa972304525652b5e0118e698ca88.js"> </script>

<p><br></p>

<h3 id="karpenterhelm">Karpenter — Helm</h3>

<p>O Setup do Helm é baseado no da documentação do Karpenter com Terraform também. Vamos passar a role que criamos amarrada ao OIDC e ao <strong><em>WebIdentityProvider</em></strong> na Service Account para que o controlador possa executar operações nas API’s da AWS.</p>

<noscript><pre>400: Invalid request</pre></noscript>
<script src="https://gist.github.com/79a5fdb0445fa0e2a9efbad4e5a0cb1b.js"> </script>

<p><img src="https://cdn-images-1.medium.com/max/770/1*VAlTbC20qhEBdkBWfcJ0Ag.png" alt="Karpenter Image"></p>

<p>Após o provisionamento teremos também o pod do Karpenter com os dois containers internos em estado de Ready/Running rodando em um Node Fargate idêntico aos do exemplo do <strong><em>kube-system</em></strong>.</p>

<p><br></p>

<h3 id="karpenterprovisioner-e-templates">Karpenter — Provisioner e Templates</h3>

<p>Agora vamos trabalhar com o real diferencial dessa PoC com os demais tipos de provisionamento mais comuns. Caso você já tenha trabalhado com o provisionamento de clusters de EKS com Node Groups com Launch Templates customizados, essa parte será bem parecida.</p>

<p>No caso vamos criar um launch template versionado utilizando as AMI’s recomendadas da AWS e a instance profile que criamos de antemão. Alguns passos de configuração como user-data foram omitidos do artigo, mas ressaltando que podem ser consultados no repositório de exemplo do artigo.</p>

<noscript><pre>400: Invalid request</pre></noscript>
<script src="https://gist.github.com/f3ba98e06fcb612f2dadd276098bcdb0.js"> </script>

<p>Em seguida vamos criar dois objetos pelo objeto <strong><em>kubectl_manifest</em></strong> do provider do kubectl para fazer deploy de dois recursos do CRD do Karpenter, um deles sendo o Provisioner onde vamos especificar os tamanhos de instancias, limites de CPU e memória e coisas relacionadas a capacity e outro sendo um AWSNodeTemplate onde vamos especificar os launch templates dos nodes.</p>

<noscript><pre>400: Invalid request</pre></noscript>
<script src="https://gist.github.com/0d22da87de84530d130b9173a087375a.js"> </script>

<p>Para facilitar eu optei por usar <strong><em>templatefile</em></strong> para criar os manifestos que seriam aplicados pelo provider do kubectl. No caso para ficar mais evidente, coloquei algumas variáveis para fazer o build dos YAMLs via template dessa forma:</p>

<noscript><pre>400: Invalid request</pre></noscript>
<script src="https://gist.github.com/a4b9eb55b5335b7d78d4c30e2a2746d0.js"> </script>

<noscript><pre>400: Invalid request</pre></noscript>
<script src="https://gist.github.com/a632e2bb18ca95c72fc597c37784c860.js"> </script>

<p>No final será criado um resource parecido com o abaixo:</p>

<noscript><pre>400: Invalid request</pre></noscript>
<script src="https://gist.github.com/5f44a5231cd54d0876a9c14d08d8e4b2.js"> </script>

<p><strong>Disclaimer:</strong> <em>Durante a PoC tentei utilizar o provider do kubernetes para criar os objetos customizados do Karpenter diretamente pelo kubernetes_manifests, porém existe um bug de dependências no resource que inviabiliza o provisionamento de CRD’s juntamente com o cluster. Por isso precisei utilizar o kubectl provider para que continue sendo possível o provisionamento de toda a infraestrutura de uma única vez.</em></p>

<p><em>Abri uma issue que permanece aberta (até esse momento) pra isso:</em></p>

<p><a href="https://github.com/hashicorp/terraform-provider-kubernetes/issues/1775">Error: Failed to construct REST client on kubernetes_manifest resource · Issue #1775 · hashicorp/terraform-provider-kubernetes</a></p>

<p><br></p>

<h1 id="aplicação-de-testes">Aplicação de Testes</h1>

<p>Agora que temos todos os recursos do cluster minimamente provisionados, vamos testar o funcionamento do Karpenter. Vamos fazer deploy de uma aplicação de exemplo para ver se os nodes vão ser provisionados para suprir o novo capacity solicitado.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>❯ kubectl apply <span class="nt">-f</span> files/deploy/demo/chip.yaml
namespace/chip created
deployment.apps/chip created
service/chip created
horizontalpodautoscaler.autoscaling/chip created
</pre></td></tr></tbody></table></code></pre></div></div>

<p>No caso foi provisionado para suprir os 2 novos pods solicitados para a aplicação de exemplo. Agora vamos executar os cenários de scale in e out para ver como o ambiente se comporta.</p>

<p><img src="https://cdn-images-1.medium.com/max/1024/1*DOlh-cIezLOTNGpjO1GWOQ.png" alt="Image"></p>

<p><img src="https://cdn-images-1.medium.com/max/1024/1*ylV5ifomSJw1UHOvIk0bQg.png" alt="Image"></p>

<p><br></p>

<h3 id="cenário-1scale-in">Cenário 1 — Scale In</h3>

<p>Vamos exemplificar o cenário onde temos 4 nodes iniciais no cluster, e vamos fazer o scale de um deployment de 2 replicas para 100 de forma brusca para ver como o Karpenter vai lidar com essa mudança de capacity solicitado.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>kubectl scale <span class="nt">--replicas</span> 100 deployment/chip <span class="nt">-n</span> chip
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn-images-1.medium.com/max/800/1*wYPdjUBQZPWPQPmCmiUNGw.png" alt="Image"></p>

<p><strong>Replicas iniciais do deployment:</strong> 4
<strong>Replicas desejadas do deployment:</strong> 100
<strong>CPU Requests:</strong> 250m
<strong>RAM Requests:</strong> 512m
<strong>Quantidade de Nodes Iniciais:</strong> 4
<strong>Quantidade de Nodes final:</strong> 25
<strong>Horário do Apply:</strong> 17:10:35
<strong>Horário do scale finalizado:</strong> 17:13:50
<strong>Tempo Total:</strong> 00:03:25</p>

<p><img src="https://cdn-images-1.medium.com/proxy/1*27pFs8GxbM1F4FLA6aTlEg.png" alt="Image"></p>

<p>Conseguimos provisionar um capacity para suprir uma demanda brusca de 4 para 100 unidades computacionais que necessitavam de nodes em 3 minutos.</p>

<p><br></p>

<h3 id="cenário-2scale-out">Cenário 2 — Scale Out</h3>

<p>Agora vamos testar o cenário inverso, onde vamos fazer o scale out do ambiente de forma brusca para avaliar como karpenter vai lidar com esse capacity fora de uso.</p>

<p><img src="https://cdn-images-1.medium.com/max/800/1*ClVeK_eB__7F8osL1kYmRg.png" alt="Image"></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>kubectl scale <span class="nt">--replicas</span> 4 deployment/chip <span class="nt">-n</span> chip
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>Replicas iniciais do deployment:</strong> 100
<strong>Replicas desejadas do deployment:</strong> 4
<strong>CPU Requests:</strong> 250m
<strong>RAM Requests:</strong> 512m
<strong>Quantidade de Nodes Iniciais:</strong> 25
<strong>Quantidade de Nodes final:</strong> 4
<strong>Horário do Apply:</strong> 17:18:55
<strong>Horário do scale finalizado:</strong> 17:19:50
<strong>Tempo Total:</strong> 00:00:55</p>

<p>Para o scale out de nodes em desuso foi ainda melhor que scale in, fazendo um desligamento em massa de 25 nodes para 4 em 55 segundos.</p>

<p><strong>Lembrando que toda a PoC foi disponibilizada no <a href="https://github.com/msfidelis/eks-karpenter-autonomous-cluster">Github</a>.</strong></p>

<p><br></p>

<h4 id="obrigado-aos-revisores">Obrigado aos Revisores:</h4>

<ul>
  <li><strong>Rafael Silva</strong> — <a href="https://mobile.twitter.com/rafaotetra">@rafaotetra</a></li>
  <li><strong>Gabriel Machado</strong> — <a href="https://twitter.com/gmsantos__">@gmsantos_</a></li>
  <li><strong>Somatorio </strong>— @somatorio</li>
</ul>

<p><br></p>

<h4 id="referencias">Referencias:</h4>

<ul>
  <li><strong>Karpenter — Getting Started with Terraform </strong>— <a href="https://karpenter.sh/v0.5.3/getting-started-with-terraform/">https://karpenter.sh/v0.5.3/getting-started-with-terraform/</a></li>
  <li><strong>Karpenter Best Pratices</strong> — <a href="https://aws.github.io/aws-eks-best-practices/karpenter/">https://aws.github.io/aws-eks-best-practices/karpenter/</a></li>
  <li><strong>Karpenter — Topology Spreads</strong> — <a href="https://karpenter.sh/v0.13.2/tasks/scheduling/#topology-spread">https://karpenter.sh/v0.13.2/tasks/scheduling/#topology-spread</a></li>
  <li><strong>Deploy CoreDNS on Amazon EKS with Fargate automatically using Terraform and Python</strong> — <a href="https://docs.aws.amazon.com/prescriptive-guidance/latest/patterns/deploy-coredns-on-amazon-eks-with-fargate-automatically-using-terraform-and-python.html">https://docs.aws.amazon.com/prescriptive-guidance/latest/patterns/deploy-coredns-on-amazon-eks-with-fargate-automatically-using-terraform-and-python.html</a></li>
</ul>

<p><br></p>

<p>Me <a href="https://twitter.com/fidelissauro">sigam no Twitter</a> para acompanhar as paradinhas que eu compartilho por lá!</p>

<p>Te ajudei de alguma forma? Me pague um café (<em>mentira, todas as doações são convertidas para abrigos de animais da minha cidade</em>)</p>

<p><strong>Chave Pix:</strong> fe60fe92-ecba-4165-be5a-3dccf8a06bfc</p>

            </div>

            <!-- Rating -->
            

            <!-- Post Date -->
            <p>
            <small>
                <span class="post-date"><time class="post-date" datetime="2022-08-05">05 Aug 2022</time></span>           
                
                </small>
            </p>

            <!-- Post Categories -->
            <div class="after-post-cats">
                <ul class="tags mb-4">
                    
                    
                    <li>
                        <a class="smoothscroll" href="/categories#arquitetura">arquitetura</a>
                    </li>
                    
                    <li>
                        <a class="smoothscroll" href="/categories#aws">aws</a>
                    </li>
                    
                    <li>
                        <a class="smoothscroll" href="/categories#karpenter">karpenter</a>
                    </li>
                    
                    <li>
                        <a class="smoothscroll" href="/categories#kubernetes">kubernetes</a>
                    </li>
                    
                    <li>
                        <a class="smoothscroll" href="/categories#terraform">terraform</a>
                    </li>
                    
                </ul>
            </div>
            <!-- End Categories -->

            <!-- Post Tags -->
            <div class="after-post-tags">
                <ul class="tags">
                    
                    
                </ul>
            </div>
            <!-- End Tags -->

            <!-- Prev/Next -->
            <div class="row PageNavigation d-flex justify-content-between font-weight-bold">
            
            <a class="prev d-block col-md-6" href="//sobrevivendo-a-cenarios-de-caos-no-kubernetes-com-istio-e-amazon-eks/"> &laquo; Sobrevivendo a cenários de caos no Kubernetes com Istio e Amazon EKS</a>
            
            
            <a class="next d-block col-md-6 text-lg-right" href="//karpenter-estrategias-para-resiliencia-no-uso-de-spot-instances-em-producao/">Karpenter — Estratégias para resiliência no uso de Spot Instances em produção &raquo; </a>
            
            <div class="clearfix"></div>
            </div>
            <!-- End Categories -->

        </div>
        <!-- End Post -->

    </div>
</div>
<!-- End Article
================================================== -->

<!-- Begin Comments
================================================== -->

    <div class="container">
        <div id="comments" class="row justify-content-center mb-5">
            <div class="col-md-8">
                <section class="disqus">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = ''; 
        var disqus_developer = 0;
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = window.location.protocol + '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>

            </div>
        </div>
    </div>

<!--End Comments
================================================== -->

<!-- Review with LD-JSON, adapt it for your needs if you like, but make sure you test the generated HTML source code first: 
https://search.google.com/structured-data/testing-tool/u/0/
================================================== -->

</div>

<!-- 
<!-- Bottom Alert Bar
================================================== -->
<div class="alertbar">
	<div class="container text-center">
		<span><img src="/assets/images/logo.png" alt="Matheus Fidelis - Engineering Blog"> &nbsp; Never miss a <b>story</b> from us, subscribe to our newsletter</span>
        <form action="https://wowthemes.us11.list-manage.com/subscribe/post?u=8aeb20a530e124561927d3bd8&amp;id=8c3d2d214b" method="post" name="mc-embedded-subscribe-form" class="wj-contact-form validate" target="_blank" novalidate>
            <div class="mc-field-group">
            <input type="email" placeholder="Email" name="EMAIL" class="required email" id="mce-EMAIL" autocomplete="on" required>
            <input type="submit" value="Subscribe" name="subscribe" class="heart">
            </div>
        </form>
	</div>
</div>
 -->
    
</div>

<!-- Categories Jumbotron
================================================== -->
<div class="jumbotron fortags">
	<div class="d-md-flex h-100">
		<div class="col-md-4 transpdark align-self-center text-center h-100">
            <div class="d-md-flex align-items-center justify-content-center h-100">
                <h2 class="d-md-block align-self-center py-1 font-weight-light">Explore <span class="d-none d-md-inline">→</span></h2>
            </div>
		</div>
		<div class="col-md-8 p-5 align-self-center text-center">
            
            
                
                    <a class="mt-1 mb-1" href="/categories#kubernetes">kubernetes (5)</a>
                
                    <a class="mt-1 mb-1" href="/categories#istio">istio (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#disaster-recovery">disaster-recovery (2)</a>
                
                    <a class="mt-1 mb-1" href="/categories#service-mesh">service-mesh (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#aws">aws (4)</a>
                
                    <a class="mt-1 mb-1" href="/categories#arquitetura">arquitetura (3)</a>
                
                    <a class="mt-1 mb-1" href="/categories#terraform">terraform (4)</a>
                
                    <a class="mt-1 mb-1" href="/categories#karpenter">karpenter (2)</a>
                
                    <a class="mt-1 mb-1" href="/categories#argo-rollouts">argo-rollouts (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#keda">keda (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#containers">containers (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#cloud-native">cloud-native (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#capacity">capacity (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#dicas">dicas (1)</a>
                
            
            
		</div>
	</div>
</div>

<!-- Begin Footer
================================================== -->
<footer class="footer">
    <div class="container">
        <div class="row">
            <div class="col-md-6 col-sm-6 text-center text-lg-left">
                Copyright © 2023 Matheus Fidelis 
            </div>
            <div class="col-md-6 col-sm-6 text-center text-lg-right">    
                <a target="_blank" href="https://www.wowthemes.net/mediumish-free-jekyll-template/">Mediumish Jekyll Theme</a> by WowThemes.net
            </div>
        </div>
    </div>
</footer>
<!-- End Footer
================================================== -->

</div> <!-- /.site-content -->

<!-- Scripts
================================================== -->

<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js" integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut" crossorigin="anonymous"></script>

<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js" integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k" crossorigin="anonymous"></script>

<script src="/assets/js/mediumish.js"></script>


<script src="/assets/js/lazyload.js"></script>


<script src="/assets/js/ie10-viewport-bug-workaround.js"></script> 


<script id="dsq-count-scr" src="//.disqus.com/count.js"></script>



<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-4Z30K3KNFW"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-4Z30K3KNFW');
</script>



</body>
</html>
