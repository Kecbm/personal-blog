<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<link rel="icon" href="/assets/images/logo.png">

<title>Disaster Recovery — Projetando e Gerenciando Arquiteturas Multi-Region na AWS com Terraform | Matheus Fidelis</title>

<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Disaster Recovery — Projetando e Gerenciando Arquiteturas Multi-Region na AWS com Terraform | Matheus Fidelis - Engineering Blog</title>
<meta name="generator" content="Jekyll v4.3.2" />
<meta property="og:title" content="Disaster Recovery — Projetando e Gerenciando Arquiteturas Multi-Region na AWS com Terraform" />
<meta name="author" content="matheus" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Este artigo foi o mais longo e cansativo que escrevi em muito tempo, então considere esse disclaimer como um pedido de desculpas escrito após a finalização do mesmo. Recomendo que leia aos poucos, com calma. Entrei em um hiperfoco violento que me fez cuspir tudo que estava na minha cabeça de uma vez, então peço perdão por isso e insisto que você não desista dessa leitura pela extensão." />
<meta property="og:description" content="Este artigo foi o mais longo e cansativo que escrevi em muito tempo, então considere esse disclaimer como um pedido de desculpas escrito após a finalização do mesmo. Recomendo que leia aos poucos, com calma. Entrei em um hiperfoco violento que me fez cuspir tudo que estava na minha cabeça de uma vez, então peço perdão por isso e insisto que você não desista dessa leitura pela extensão." />
<link rel="canonical" href="https://medium.com/@fidelissauro/disaster-recovery-projetando-e-gerenciando-arquiteturas-multi-region-na-aws-com-terraform-8e9a6a9a8669?source=rss-fc2fda5e9bc2------2" />
<meta property="og:url" content="https://medium.com/@fidelissauro/disaster-recovery-projetando-e-gerenciando-arquiteturas-multi-region-na-aws-com-terraform-8e9a6a9a8669?source=rss-fc2fda5e9bc2------2" />
<meta property="og:site_name" content="Matheus Fidelis - Engineering Blog" />
<meta property="og:image" content="http://localhost:4000/assets/images/dr-logo-vg.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2023-07-15T00:00:00-03:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="http://localhost:4000/assets/images/dr-logo-vg.png" />
<meta property="twitter:title" content="Disaster Recovery — Projetando e Gerenciando Arquiteturas Multi-Region na AWS com Terraform" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"matheus"},"dateModified":"2023-07-15T00:00:00-03:00","datePublished":"2023-07-15T00:00:00-03:00","description":"Este artigo foi o mais longo e cansativo que escrevi em muito tempo, então considere esse disclaimer como um pedido de desculpas escrito após a finalização do mesmo. Recomendo que leia aos poucos, com calma. Entrei em um hiperfoco violento que me fez cuspir tudo que estava na minha cabeça de uma vez, então peço perdão por isso e insisto que você não desista dessa leitura pela extensão.","headline":"Disaster Recovery — Projetando e Gerenciando Arquiteturas Multi-Region na AWS com Terraform","image":"http://localhost:4000/assets/images/dr-logo-vg.png","mainEntityOfPage":{"@type":"WebPage","@id":"https://medium.com/@fidelissauro/disaster-recovery-projetando-e-gerenciando-arquiteturas-multi-region-na-aws-com-terraform-8e9a6a9a8669?source=rss-fc2fda5e9bc2------2"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://localhost:4000/assets/images/logo.png"},"name":"matheus"},"url":"https://medium.com/@fidelissauro/disaster-recovery-projetando-e-gerenciando-arquiteturas-multi-region-na-aws-com-terraform-8e9a6a9a8669?source=rss-fc2fda5e9bc2------2"}</script>
<!-- End Jekyll SEO tag -->


<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    
<link href="/assets/css/screen.css" rel="stylesheet">

<link href="/assets/css/main.css" rel="stylesheet">

<script src="/assets/js/jquery.min.js"></script>

</head>




<body class="layout-post">
	<!-- defer loading of font and font awesome -->
	<noscript id="deferred-styles">
		<link href="https://fonts.googleapis.com/css?family=Righteous%7CMerriweather:300,300i,400,400i,700,700i" rel="stylesheet">
		<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">
	</noscript>


<!-- Begin Menu Navigation
================================================== -->
<nav class="navbar navbar-expand-lg navbar-light bg-white fixed-top mediumnavigation nav-down">

    <div class="container pr-0">

    <!-- Begin Logo -->
    <a class="navbar-brand" href="/">
    <img src="/assets/images/logo.png" alt="Matheus Fidelis">
    </a>
    <!-- End Logo -->

    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarMediumish" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarMediumish">

        <!-- Begin Menu -->

            <ul class="navbar-nav ml-auto">

                
                <li class="nav-item">
                
                <a class="nav-link" href="/index.html">Blog</a>
                </li>

                <li class="nav-item">
                <a class="nav-link" href="/about">Sobre</a>
                </li>

                <li class="nav-item">
                    <a class="nav-link" target=”_blank” href="/feed.xml">RSS</a>
                </li>

                <li class="nav-item">
                    <a class="nav-link" target=”_blank” href="https://fidelissauro.substack.com/">Newsletter</a>
                </li>

                <script src="/assets/js/lunr.js"></script>


<style>
    .lunrsearchresult .title {color: #d9230f;}
    .lunrsearchresult .url {color: silver;}
    .lunrsearchresult a {display: block; color: #777;}
    .lunrsearchresult a:hover, .lunrsearchresult a:focus {text-decoration: none;}
    .lunrsearchresult a:hover .title {text-decoration: underline;}
</style>


<form class="bd-search" onSubmit="return lunr_search(document.getElementById('lunrsearch').value);">
    <input type="text" class="form-control text-small launch-modal-search" id="lunrsearch" name="q" maxlength="255" value="" placeholder="Type and enter..."/>
</form>

<div id="lunrsearchresults">
    <ul></ul>
</div>

<script src="/assets/js/lunrsearchengine.js"></script>

            </ul>

        <!-- End Menu -->

    </div>

    </div>
</nav>
<!-- End Navigation
================================================== -->

<div class="site-content">

<div class="container">

<!-- Site Title
================================================== -->
<div class="mainheading">
    <h1 class="sitetitle">Matheus Fidelis</h1>
    <p class="lead">
        Technical Blog
    </p>
</div>

<!-- Content
================================================== -->
<div class="main-content">
    <!-- Begin Article
================================================== -->
<div class="container">
    <div class="row">

        <!-- Post Share -->
        <div class="col-md-2 pl-0">
            <div class="share sticky-top sticky-top-offset">
    <p>
        Share
    </p>
    <ul>
        <li class="ml-1 mr-1">
            <a target="_blank" href="https://twitter.com/intent/tweet?text=Disaster Recovery — Projetando e Gerenciando Arquiteturas Multi-Region na AWS com Terraform&url=http://localhost:4000/disaster-recovery-projetando-e-gerenciando-arquiteturas-multi-region-na-aws-com-terraform/" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                <i class="fab fa-twitter"></i>
            </a>
        </li>

        <li class="ml-1 mr-1">
            <a target="_blank" href="https://facebook.com/sharer.php?u=http://localhost:4000/disaster-recovery-projetando-e-gerenciando-arquiteturas-multi-region-na-aws-com-terraform/" onclick="window.open(this.href, 'facebook-share', 'width=550,height=435');return false;">
                <i class="fab fa-facebook-f"></i>
            </a>
        </li>

        <li class="ml-1 mr-1">
            <a target="_blank" href="https://www.linkedin.com/shareArticle?mini=true&url=http://localhost:4000/disaster-recovery-projetando-e-gerenciando-arquiteturas-multi-region-na-aws-com-terraform/" onclick="window.open(this.href, 'width=550,height=435');return false;">
                <i class="fab fa-linkedin-in"></i>
            </a>
        </li>

    </ul>
    
    <div class="sep">
    </div>
    <ul>
        <li>
        <a class="small smoothscroll" href="#disqus_thread"></a>
        </li>
    </ul>
    
</div>

        </div>

        <!-- Post -->
        

        <div class="col-md-9 flex-first flex-md-unordered">
            <div class="mainheading">

                <!-- Author Box -->
                
                <div class="row post-top-meta">
                    <div class="col-xs-12 col-md-3 col-lg-2 text-center text-md-left mb-4 mb-md-0">
                        
                        <img class="author-thumb" src="https://www.gravatar.com/avatar/5700ede08434f0ab49b75fe5543f129b?s=250&d=mm&r=x" alt="Matheus Fidelis">
                        
                    </div>
                    <div class="col-xs-12 col-md-9 col-lg-10 text-center text-md-left">
                        <a target="_blank" class="link-dark" href="https://msfidelis.github.io/">Matheus Fidelis</a><a target="_blank" href="https://twitter.com/fidelissauro" class="btn follow">Follow</a>
                        <span class="author-description">Staff Engineer, Lifelong Learner, Site Reliability Engineer, Cloud and Containers Wizard, Software Alchemist and Home Bartender</span>
                    </div>
                </div>
                

                <!-- Post Title -->
                <h1 class="posttitle">Disaster Recovery — Projetando e Gerenciando Arquiteturas Multi-Region na AWS com Terraform</h1>

            </div>

            <!-- Adsense if enabled from _config.yml (change your pub id and slot) -->
            
            <!-- End Adsense -->

            <!-- Post Featured Image -->
            

            
            <img class="featured-image img-fluid lazyimg" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAMAAAACCAQAAAA3fa6RAAAADklEQVR42mNkAANGCAUAACMAA2w/AMgAAAAASUVORK5CYII=" data-src="/assets/images/dr-logo-vg.png" alt="Disaster Recovery — Projetando e Gerenciando Arquiteturas Multi-Region na AWS com Terraform">
            

            
            <!-- End Featured Image -->

            <!-- Post Content -->
            <div class="article-post">
                <!-- Toc if any -->
                
                <!-- End Toc -->
                <p>Este artigo foi o mais longo e cansativo que escrevi em muito tempo, então considere esse disclaimer como um pedido de desculpas escrito após a finalização do mesmo. <strong>Recomendo que leia aos poucos, com calma</strong>. Entrei em um <em>hiperfoco</em> violento que me fez cuspir tudo que estava na minha cabeça de uma vez, então peço perdão por isso e insisto que você não desista dessa leitura pela extensão.</p>

<p>Refleti muito se deveria lança-lo por partes menores, mesmo não gostando desse modelo. Na verdade nada me deixa mais decepcionado do que estar empolgado na leitura de um artigo e do nada ele acabar no <strong><em>“like pra parte 2”</em></strong>. Então salve esse cara nos seus favoritos e por favor, não desista dele.</p>

<p><br></p>

<h1 id="terraform-e-disaster-recovery">Terraform e Disaster Recovery</h1>

<p>O <strong>Disaster Recovery</strong> (Recuperação de Desastres) é uma estratégia essencial para garantir a continuidade dos negócios e a resiliência de sistemas críticos em caso de falhas ou interrupções inesperadas. Com o aumento da dependência de serviços e aplicações na nuvem, a adoção de soluções de recuperação de desastres se tornou ainda mais crucial para proteger os dados e garantir a disponibilidade dos serviços.</p>

<p>Além de ser uma poderosa ferramenta de <strong>Infraestrutura como Código</strong>, o Terraform pode desempenhar um papel fundamental na implementação de estratégias de chaveamento (failover) e recuperação de desastres (DR) na nuvem. Com sua capacidade de gerenciar recursos de infraestrutura em várias regiões e provedores de nuvem, o Terraform se torna uma escolha natural para automatizar a criação e a configuração de ambientes de chaveamento e DR altamente resilientes.</p>

<p>Neste artigo, exploraremos como o Terraform pode ser utilizado como uma ferramenta abrangente para orquestrar ambientes de chaveamento e DR na <strong>AWS (Amazon Web Services)</strong>. Veremos como podemos aproveitar a flexibilidade e a facilidade de uso do Terraform para criar arquiteturas de failover que garantem a continuidade dos serviços em caso de falhas ou interrupções inesperadas. Como exemplo prático, implementaremos uma proposta funcional de uma arquitetura reduzida que pode se manter funcionando em casos de abordagens ativo/ativo ou ativo/passivo, fazendo uso de algumas estratégias e serviços que possuam features de replicação, balanceamento chaveamento automático, e trabalhando de forma espelhadas entre duas regiões da AWS.</p>

<p><br></p>

<h2 id="premissas-e-estratégias-da-nossa-arquitetura">Premissas e estratégias da nossa arquitetura</h2>

<p>É possível pensar e filosofar em centenas de possibilidade de se projetar uma estrutura em nuvem, porém a que vamos escolher aqui tem o objetivo central de se manter o mais simples possível e aproveitar o máximo de coisas <em>“as a service”</em> que a AWS oferece por meio dos seus produtos.</p>

<p>Nesse caso, vamos assumir de antemão as seguintes premissas:</p>

<ul>
  <li>Vamos dar prioridade <strong>para o máximo de serviços Serverless possível</strong>. Nossa estratégia será desenhada em torno dessas soluções para mantermos o máximo de simplicidade possível. Por serem altamente gerenciados pelos provedores de nuvem, esses serviços costumam ser mais rápidos e fáceis de provisionar e utilizar.</li>
  <li>Vamos dar extrema prioridade para serviços que ofereçam <strong>replicação de dados</strong>, principalmente que funcionem de <strong>forma bilateral</strong> e nos facilite na virada e no retorno entre a região primária e de DR de forma rápida.</li>
  <li>Voltando ao tópico anterior, a AWS possui vários e vários serviços que possibilitam trabalhar em Multi-Region de alguma forma, porém a maioria deles serão despriorizados por necessitarem de algum tipo de intervenção manual para o DR, ou que não possibilitem trabalhar ATIVO/ATIVO, como no caso de serviços que mantenham uma região <strong>Read Only</strong>, <strong>Replica</strong> e etc.</li>
  <li>Iremos presumir que a estratégia de DR seja executada manualmente e com base em certos critérios estabelecidos de maneira lúdica previamente. Uma forma bonita de dizer que pro DR acontecer, será necessário executar o Terraform por algum lugar, por alguém, por algum motivo.</li>
</ul>

<p><br></p>

<h2 id="terraform-em-multi-region">Terraform em Multi-Region</h2>

<p>Configurar o Terraform para trabalhar em multi região na AWS é um passo crucial dentro desta proposta para estabelecer uma estratégia eficaz de Disaster Recovery. Através do uso de variáveis e providers específicos para cada região, você pode garantir que seus recursos críticos sejam replicados e disponibilizados em regiões geograficamente distantes, aumentando a resiliência e a disponibilidade da sua aplicação.</p>

<p>O Terraform suporta múltiplas definições do mesmo provider, sendo diferenciado por um alias para ser referenciado posteriormente. Nesse caso, vamos estabelecer dois providers idênticos da AWS e criar os alias <code class="language-plaintext highlighter-rouge">primary</code> e <code class="language-plaintext highlighter-rouge">disaster-recovery</code>.</p>

<p>Para essa demonstração iremos assumir a região <code class="language-plaintext highlighter-rouge">primary</code> seja em <strong>São Paulo (sa-east-1)</strong> e a região de <code class="language-plaintext highlighter-rouge">disaster-recovery</code> sendo em <strong>Norte Virginia (us-east-1)</strong>.</p>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="nx">provider</span> <span class="s2">"aws"</span> <span class="p">{</span>
  <span class="nx">alias</span>  <span class="p">=</span> <span class="s2">"primary"</span>
  <span class="nx">region</span> <span class="p">=</span> <span class="s2">"sa-east-1"</span>
<span class="p">}</span>

<span class="nx">provider</span> <span class="s2">"aws"</span> <span class="p">{</span>
  <span class="nx">alias</span>  <span class="p">=</span> <span class="s2">"disaster-recovery"</span>
  <span class="nx">region</span> <span class="p">=</span> <span class="s2">"us-east-1"</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><br></p>

<h3 id="recursos-modulares--especialistas-ou-genéricos">Recursos Modulares — Especialistas ou Genéricos</h3>

<p>Para que esta prova de conceito funcione, precisaremos investir em uma arquitetura de Infraestrutura como <strong>Código Modular</strong>, ou criar objetos de IaC (Infraestrutura como Código) que resolvem problemas de forma padronizada e que podem ser reutilizados diversas vezes, com base em parâmetros de entrada. Isso nos permitirá fornecer o mesmo recurso em ambas as regiões com a mesma linha de base de configuração.</p>

<p><img src="https://cdn-images-1.medium.com/max/642/1*_ZlYyfslMuwO31QitfRoGg.png" alt="Imagem representativa de recursos modulares"></p>

<p><br></p>

<h4 id="e-como-fazemos-isso">E como fazemos isso?</h4>

<p>Para este exemplo, utilizaremos variáveis que são construídas por meio de <a href="https://developer.hashicorp.com/terraform/language/expressions/types#maps-objects">maps</a>, para então usarmos a função <code class="language-plaintext highlighter-rouge">lookup</code> para recuperar os valores. Neste caso, a chave dos maps será o nome da região, ou seja, <code class="language-plaintext highlighter-rouge">sa-east-1</code> e <code class="language-plaintext highlighter-rouge">us-east-1</code>. Poderia ser <code class="language-plaintext highlighter-rouge">primary</code> ou <code class="language-plaintext highlighter-rouge">secondary</code>, <code class="language-plaintext highlighter-rouge">active</code> ou <code class="language-plaintext highlighter-rouge">passive</code>, ou qualquer outra denominação que faça sentido.</p>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td><td class="rouge-code"><pre><span class="nx">variable</span> <span class="s2">"vpc_cidr"</span> <span class="p">{</span>
  <span class="nx">type</span> <span class="p">=</span> <span class="nx">map</span><span class="p">(</span><span class="nx">any</span><span class="p">)</span>
  <span class="nx">default</span> <span class="p">=</span> <span class="p">{</span>
    <span class="nx">us-east-1</span> <span class="p">=</span> <span class="s2">"10.0.0.0/16"</span>
    <span class="nx">sa-east-1</span> <span class="p">=</span> <span class="s2">"172.0.0.0/16"</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">variable</span> <span class="s2">"public_subnet_1a"</span> <span class="p">{</span>
  <span class="nx">type</span> <span class="p">=</span> <span class="nx">map</span><span class="p">(</span><span class="nx">any</span><span class="p">)</span>
  <span class="nx">default</span> <span class="p">=</span> <span class="p">{</span>
    <span class="nx">us-east-1</span> <span class="p">=</span> <span class="s2">"10.0.0.0/20"</span>
    <span class="nx">sa-east-1</span> <span class="p">=</span> <span class="s2">"172.0.0.0/20"</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">variable</span> <span class="s2">"public_subnet_1b"</span> <span class="p">{</span>
  <span class="nx">type</span> <span class="p">=</span> <span class="nx">map</span><span class="p">(</span><span class="nx">any</span><span class="p">)</span>
  <span class="nx">default</span> <span class="p">=</span> <span class="p">{</span>
    <span class="nx">us-east-1</span> <span class="p">=</span> <span class="s2">"10.0.16.0/20"</span>
    <span class="nx">sa-east-1</span> <span class="p">=</span> <span class="s2">"172.0.16.0/20"</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="c1">// ...</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Nesse caso, encapsulamos a criação de toda a rede da VPC em um módulo e utilizamos o mesmo como fonte duas vezes, passando os mesmos inputs, porém com a busca pela chave da região específica no <a href="https://developer.hashicorp.com/terraform/language/functions/lookup">lookup</a>.</p>

<p>Como definimos no primeiro passo os dois provedores da AWS com seus respectivos alias, precisamos informar ao módulo qual deles deve ser utilizado para criar os recursos.</p>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
</pre></td><td class="rouge-code"><pre><span class="nx">module</span> <span class="s2">"vpc_sa_east_1"</span> <span class="p">{</span>
  <span class="nx">source</span> <span class="p">=</span> <span class="s2">"./modules/vpc"</span>

  <span class="nx">providers</span> <span class="p">=</span> <span class="p">{</span>
    <span class="nx">aws</span> <span class="p">=</span> <span class="nx">aws</span><span class="p">.</span><span class="nx">primary</span>
  <span class="p">}</span>

  <span class="nx">project_name</span> <span class="p">=</span> <span class="s2">"primary"</span>
  <span class="nx">vpc_cidr</span>     <span class="p">=</span> <span class="nx">lookup</span><span class="p">(</span><span class="nx">var</span><span class="p">.</span><span class="nx">vpc_cidr</span><span class="p">,</span> <span class="s2">"sa-east-1"</span><span class="p">)</span>

  <span class="nx">public_subnet_1a</span> <span class="p">=</span> <span class="nx">lookup</span><span class="p">(</span><span class="nx">var</span><span class="p">.</span><span class="nx">public_subnet_1a</span><span class="p">,</span> <span class="s2">"sa-east-1"</span><span class="p">)</span>
  <span class="nx">public_subnet_1b</span> <span class="p">=</span> <span class="nx">lookup</span><span class="p">(</span><span class="nx">var</span><span class="p">.</span><span class="nx">public_subnet_1b</span><span class="p">,</span> <span class="s2">"sa-east-1"</span><span class="p">)</span>
  <span class="nx">public_subnet_1c</span> <span class="p">=</span> <span class="nx">lookup</span><span class="p">(</span><span class="nx">var</span><span class="p">.</span><span class="nx">public_subnet_1c</span><span class="p">,</span> <span class="s2">"sa-east-1"</span><span class="p">)</span>

  <span class="nx">private_subnet_1a</span> <span class="p">=</span> <span class="nx">lookup</span><span class="p">(</span><span class="nx">var</span><span class="p">.</span><span class="nx">private_subnet_1a</span><span class="p">,</span> <span class="s2">"sa-east-1"</span><span class="p">)</span>
  <span class="nx">private_subnet_1b</span> <span class="p">=</span> <span class="nx">lookup</span><span class="p">(</span><span class="nx">var</span><span class="p">.</span><span class="nx">private_subnet_1b</span><span class="p">,</span> <span class="s2">"sa-east-1"</span><span class="p">)</span>
  <span class="nx">private_subnet_1c</span> <span class="p">=</span> <span class="nx">lookup</span><span class="p">(</span><span class="nx">var</span><span class="p">.</span><span class="nx">private_subnet_1c</span><span class="p">,</span> <span class="s2">"sa-east-1"</span><span class="p">)</span>
<span class="p">}</span>


<span class="nx">module</span> <span class="s2">"vpc_us_east_1"</span> <span class="p">{</span>
  <span class="nx">source</span> <span class="p">=</span> <span class="s2">"./modules/vpc"</span>

  <span class="nx">providers</span> <span class="p">=</span> <span class="p">{</span>
    <span class="nx">aws</span> <span class="p">=</span> <span class="nx">aws</span><span class="p">.</span><span class="nx">disaster-recovery</span>
  <span class="p">}</span>

  <span class="nx">project_name</span> <span class="p">=</span> <span class="s2">"disaster-recovery"</span>
  <span class="nx">vpc_cidr</span>     <span class="p">=</span> <span class="nx">lookup</span><span class="p">(</span><span class="nx">var</span><span class="p">.</span><span class="nx">vpc_cidr</span><span class="p">,</span> <span class="s2">"us-east-1"</span><span class="p">)</span>

  <span class="nx">public_subnet_1a</span> <span class="p">=</span> <span class="nx">lookup</span><span class="p">(</span><span class="nx">var</span><span class="p">.</span><span class="nx">public_subnet_1a</span><span class="p">,</span> <span class="s2">"us-east-1"</span><span class="p">)</span>
  <span class="nx">public_subnet_1b</span> <span class="p">=</span> <span class="nx">lookup</span><span class="p">(</span><span class="nx">var</span><span class="p">.</span><span class="nx">public_subnet_1b</span><span class="p">,</span> <span class="s2">"us-east-1"</span><span class="p">)</span>
  <span class="nx">public_subnet_1c</span> <span class="p">=</span> <span class="nx">lookup</span><span class="p">(</span><span class="nx">var</span><span class="p">.</span><span class="nx">public_subnet_1c</span><span class="p">,</span> <span class="s2">"us-east-1"</span><span class="p">)</span>

  <span class="nx">private_subnet_1a</span> <span class="p">=</span> <span class="nx">lookup</span><span class="p">(</span><span class="nx">var</span><span class="p">.</span><span class="nx">private_subnet_1a</span><span class="p">,</span> <span class="s2">"us-east-1"</span><span class="p">)</span>
  <span class="nx">private_subnet_1b</span> <span class="p">=</span> <span class="nx">lookup</span><span class="p">(</span><span class="nx">var</span><span class="p">.</span><span class="nx">private_subnet_1b</span><span class="p">,</span> <span class="s2">"us-east-1"</span><span class="p">)</span>
  <span class="nx">private_subnet_1c</span> <span class="p">=</span> <span class="nx">lookup</span><span class="p">(</span><span class="nx">var</span><span class="p">.</span><span class="nx">private_subnet_1c</span><span class="p">,</span> <span class="s2">"us-east-1"</span><span class="p">)</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><br></p>

<h4 id="uma-pausa-do-decoro">Uma pausa do decoro</h4>

<p>Eu sei que quem acompanha os meus artigos anteriores vai se sentir um pouco estranho lendo este. Estou intencionalmente tentando escrever algo de forma mais séria, e isso vai acontecer. Mas antes, preciso de uma pausa antes de continuarmos para alinhar algumas premissas:</p>

<ul>
  <li><em>Puts, mas eu prefiro trabalhar com Workspaces / Tfvars em vez de modular</em>: O céu é o seu limite!</li>
  <li><em>Prefiro separar tudo e trabalhar com tfvars separadas em vez de lookups</em>: Te amo, você é incrível!</li>
  <li><em>Acho que fazer um módulo que entrega nas duas regiões é melhor</em>: segura na mão do pai e vai</li>
  <li><em>Acho isso ruim, prefiro separar tudo e disponibilizar os outputs de outras formas</em>: confia no seu potencial, você é incrível</li>
  <li><strong>No mais: Apega-se mais na mensagem do que na cor da meia do carteiro.</strong></li>
</ul>

<p><em>Voltamos…</em></p>

<p><br></p>

<h1 id="parte-1-ingress-e-o-fluxo-síncrono">Parte 1: Ingress e o Fluxo Síncrono</h1>

<p>Na primeira parte deste artigo, vamos nos concentrar em como funcionará o fluxo síncrono de consumo do nosso serviço, considerando a necessidade de consumir uma API REST que é atendida por N aplicações (nesse escopo reduzido, apenas uma).</p>

<p>O nosso fluxo síncrono é bastante simples, e o caminho para atender a uma requisição será o seguinte:</p>

<ul>
  <li><strong>Route53:</strong> Faremos o apontamento e chaveamento de DNS por meio do Route53. Ele nos permite gerenciar e redirecionar o tráfego de forma eficiente para o local correto. Aprenderemos como utilizá-lo para chavear o tráfego entre a região primária e as de disaster recovery.</li>
  <li><strong>Custom Domain Name:</strong> Utilizaremos o Custom Domain Name para gerenciar o domínio e o certificado HTTPS/SSL da nossa API. Isso garantirá a segurança das comunicações entre o cliente e a nossa infraestrutura.</li>
  <li><strong>API Gateway Regional:</strong> A exposição da API na DMZ (zona desmilitarizada, vulgo internet, terra de ninguém) será realizada por meio do API Gateway Regional. Ele nos permitirá disponibilizar a API para o consumo externo.</li>
  <li><strong>Network Load Balancer:</strong> O Network Load Balancer funcionará como um <strong>VPC Link</strong>, direcionando o tráfego externo para dentro da nossa VPC (Virtual Private Cloud). Ele será responsável por encaminhar as requisições recebidas do API Gateway na internet para dentro da nossa infraestrutura de forma segura e correta.</li>
  <li><strong>Application Load Balancer:</strong> A gestão da camada 7 das aplicações que compõem o nosso Workload será feita pelo ALB, Application Load Balancer. Ele nos permitirá distribuir o tráfego de maneira eficiente entre os diferentes containers que executam a nossa aplicação REST. Essa camada 7 é responsável por processar solicitações HTTP e HTTPS.</li>
  <li><strong>Aplicação REST:</strong> A aplicação REST será executada em containers, que podem estar em qualquer lugar, nesse caso, utilizaremos o ECS (Elastic Container Service). O ECS nos oferece um ambiente flexível para executar nossos containers, garantindo escalabilidade e disponibilidade de forma estupidamente simples.</li>
</ul>

<p><img src="https://cdn-images-1.medium.com/max/1024/0*vJbCnJUJYYaNEEV7.png" alt="Imagem omitida"></p>

<p>Seguindo a premissa inicial utilizando a VPC de exemplo, vamos entregar todos os recursos de forma duplicada, usando as duas configurações de provedores configurados nas duas zonas de disponibilidade.</p>

<p><br></p>

<h2 id="11api-gateway-regional">1.1 — API Gateway Regional</h2>

<p>Neste exemplo, optamos por encapsular todos os mapeamentos da nossa API dentro de um <strong>módulo dedicado do API Gateway</strong>. Ao contrário de um módulo genérico que poderia ser replicado para diversos cenários, o objetivo deste módulo é fornecer todos os mapeamentos para todo o workload. Essa abordagem simplifica o encapsulamento de todas as definições do <strong>OpenAPI 3.0</strong> e facilita o entendimento da proposta.</p>

<p>É importante ressaltar que também é possível criar um módulo que aceite o OpenAPI de forma genérica, o que seria uma opção viável em um ambiente de trabalho. Optei por seguir dessa forma por praticidade do exemplo.</p>

<p>É importante considerar que o API Gateway é um recurso provisionado fora da VPC, o que significa que não temos controle físico direto sobre ele, como saber em qual Zona de Disponibilidade de determinada região ele está alocado. <strong>Nesse caso específico, é necessário fazer o deployment do API Gateway em modo Regional.</strong></p>

<p>Embora o API Gateway seja um recurso externo à VPC, o modo Regional de implantação nos <strong>permite ter uma visibilidade clara sobre a região em que a distribuição será entregue</strong>, o que é fundamental para garantir o controle que estamos almejando para o chaveamento dos workloads.</p>

<p><a href="https://github.com/msfidelis/aws-multi-region-disaster-recovery/tree/main/modules/api-gateway-app-demo"><strong>Para mais detalhes, o módulo do gateway da aplicação está aqui.</strong></a></p>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="rouge-code"><pre><span class="nx">module</span> <span class="s2">"api_gateway_app_demo_sa_east_1"</span> <span class="p">{</span>
  <span class="nx">source</span> <span class="p">=</span> <span class="s2">"./modules/api-gateway-app-demo"</span>

  <span class="nx">providers</span> <span class="p">=</span> <span class="p">{</span>
    <span class="nx">aws</span> <span class="p">=</span> <span class="nx">aws</span><span class="p">.</span><span class="nx">primary</span>
  <span class="p">}</span>

  <span class="nx">gateway_name</span> <span class="p">=</span> <span class="s2">"app-demo"</span>
  <span class="nx">stage_name</span>   <span class="p">=</span> <span class="s2">"prod"</span>
  <span class="nx">vpc_link</span>     <span class="p">=</span> <span class="nx">module</span><span class="p">.</span><span class="nx">cluster_sa_east_1</span><span class="p">.</span><span class="nx">vpc_link</span>
<span class="p">}</span>

<span class="nx">module</span> <span class="s2">"api_gateway_app_demo_us_east_1"</span> <span class="p">{</span>
  <span class="nx">source</span> <span class="p">=</span> <span class="s2">"./modules/api-gateway-app-demo"</span>

  <span class="nx">providers</span> <span class="p">=</span> <span class="p">{</span>
    <span class="nx">aws</span> <span class="p">=</span> <span class="nx">aws</span><span class="p">.</span><span class="nx">disaster-recovery</span>
  <span class="p">}</span>

  <span class="nx">gateway_name</span> <span class="p">=</span> <span class="s2">"app-demo"</span>
  <span class="nx">stage_name</span>   <span class="p">=</span> <span class="s2">"prod"</span>
  <span class="nx">vpc_link</span>     <span class="p">=</span> <span class="nx">module</span><span class="p">.</span><span class="nx">cluster_us_east_1</span><span class="p">.</span><span class="nx">vpc_link</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><br></p>

<h2 id="12--acm-regional">1.2 — ACM Regional</h2>

<p>Para garantir um deployment confiável, também faremos o deploy do <strong>ACM (AWS Certificate Manager)</strong>. O ACM é um serviço gerenciado pela AWS que permite provisionar, <strong>gerenciar e implantar certificados SSL/TLS</strong> <em>(Secure Sockets Layer/Transport Layer Security)</em> para uso em serviços da AWS, incluindo o API Gateway.</p>

<p>Ao utilizar o ACM, facilitamos a aquisição, implantação e renovação automática de certificados <em>SSL/TLS</em>, garantindo comunicações seguras entre os clientes e os recursos da AWS. <strong>Nesse caso, utilizaremos o ACM para garantir a segurança do domínio em um nível regional</strong>.</p>

<p>É importante ressaltar que <strong>as duas regiões provisionarão certificados com o mesmo nome</strong>. Essa duplicação é necessária para que possamos associar os <strong>Custom Domain Names e API Gateways</strong> específicos de cada região.</p>

<p><em>Exploraremos esse tópico no próximo tópico do artigo.</em></p>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="rouge-code"><pre><span class="nx">module</span> <span class="s2">"acm_sa_east_1"</span> <span class="p">{</span>
  <span class="nx">source</span> <span class="p">=</span> <span class="s2">"./modules/acm"</span>

  <span class="nx">providers</span> <span class="p">=</span> <span class="p">{</span>
    <span class="nx">aws</span> <span class="p">=</span> <span class="nx">aws</span><span class="p">.</span><span class="nx">primary</span>
  <span class="p">}</span>

  <span class="nx">domain_name</span>     <span class="p">=</span> <span class="nx">format</span><span class="p">(</span><span class="s2">"*.%s"</span><span class="p">,</span> <span class="nx">var</span><span class="p">.</span><span class="nx">route53_domain</span><span class="p">)</span>
  <span class="nx">route53_zone_id</span> <span class="p">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">route53_hosted_zone</span>
<span class="p">}</span>


<span class="nx">module</span> <span class="s2">"acm_us_east_1"</span> <span class="p">{</span>
  <span class="nx">source</span> <span class="p">=</span> <span class="s2">"./modules/acm"</span>

  <span class="nx">providers</span> <span class="p">=</span> <span class="p">{</span>
    <span class="nx">aws</span> <span class="p">=</span> <span class="nx">aws</span><span class="p">.</span><span class="nx">disaster-recovery</span>
  <span class="p">}</span>

  <span class="nx">domain_name</span>     <span class="p">=</span> <span class="nx">format</span><span class="p">(</span><span class="s2">"*.%s"</span><span class="p">,</span> <span class="nx">var</span><span class="p">.</span><span class="nx">route53_domain</span><span class="p">)</span>
  <span class="nx">route53_zone_id</span> <span class="p">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">route53_hosted_zone</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><br></p>

<h2 id="13--custom-domain-name">1.3 — Custom Domain Name</h2>

<p>O <strong>Custom Domain Name</strong> é a porta de entrada funcionando como um roteador de API Gateways, é onde vamos definir um domínio <strong><em>human-like</em></strong> e realizar os devidos mapeamentos. Nesse exemplo, vamos fazer um redirecionamento completo de tudo que bater nesse domínio, mas é uma das capacidades do Custom Domain Name permitir que diversos API Gateways sejam expostos através de um único domínio.</p>

<p><img src="https://cdn-images-1.medium.com/max/1024/1*t8-5htmCprCG7Okyt4hOmg.png" alt="Custom Domain Name Example"></p>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
</pre></td><td class="rouge-code"><pre><span class="nx">module</span> <span class="s2">"custom_domain_sa_east_1"</span> <span class="p">{</span>
  <span class="nx">source</span> <span class="p">=</span> <span class="s2">"./modules/api-gateway-custom-domain"</span>

  <span class="nx">providers</span> <span class="p">=</span> <span class="p">{</span>
    <span class="nx">aws</span> <span class="p">=</span> <span class="nx">aws</span><span class="p">.</span><span class="nx">primary</span>
  <span class="p">}</span>
  <span class="nx">acm_arn</span>                 <span class="p">=</span> <span class="nx">module</span><span class="p">.</span><span class="nx">acm_sa_east_1</span><span class="p">.</span><span class="nx">arn</span>
  <span class="nx">api_gateway_domain_name</span> <span class="p">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">api_gateway_domain</span>


  <span class="nx">base_path_mappings</span>      <span class="p">=</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="nx">base_path</span> <span class="p">=</span> <span class="s2">"/"</span><span class="p">,</span>
      <span class="nx">api_id</span>    <span class="p">=</span> <span class="nx">module</span><span class="p">.</span><span class="nx">api_gateway_app_demo_sa_east_1</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
      <span class="nx">stage</span>     <span class="p">=</span>  <span class="nx">module</span><span class="p">.</span><span class="nx">api_gateway_app_demo_sa_east_1</span><span class="p">.</span><span class="nx">stage</span><span class="p">,</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>


<span class="nx">module</span> <span class="s2">"custom_domain_us_east_1"</span> <span class="p">{</span>
  <span class="nx">source</span> <span class="p">=</span> <span class="s2">"./modules/api-gateway-custom-domain"</span>

  <span class="nx">providers</span> <span class="p">=</span> <span class="p">{</span>
    <span class="nx">aws</span> <span class="p">=</span> <span class="nx">aws</span><span class="p">.</span><span class="nx">disaster-recovery</span>
  <span class="p">}</span>
  <span class="nx">acm_arn</span>                 <span class="p">=</span> <span class="nx">module</span><span class="p">.</span><span class="nx">acm_us_east_1</span><span class="p">.</span><span class="nx">arn</span>
  <span class="nx">api_gateway_domain_name</span> <span class="p">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">api_gateway_domain</span>

  <span class="nx">base_path_mappings</span>      <span class="p">=</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="nx">base_path</span> <span class="p">=</span> <span class="s2">"/"</span><span class="p">,</span>
      <span class="nx">api_id</span>    <span class="p">=</span> <span class="nx">module</span><span class="p">.</span><span class="nx">api_gateway_app_demo_us_east_1</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
      <span class="nx">stage</span>     <span class="p">=</span>  <span class="nx">module</span><span class="p">.</span><span class="nx">api_gateway_app_demo_us_east_1</span><span class="p">.</span><span class="nx">stage</span><span class="p">,</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><br></p>

<h2 id="14--route53-gestão-de-dns">1.4 — Route53, Gestão de DNS</h2>

<p>Uma parte fundamental para uma estratégia de Disaster Recovery em multi-região é a capacidade de realizar o chaveamento (failover) entre os sites de forma automática e rápida. Para realizar essa tarefa, vamos utilizar o Amazon Route53, que é o serviço de DNS da AWS, junto ao Terraform para automatizar o processo de failover.</p>

<p>Vamos assumir que nossa zona já está criada e vamos referenciá-la com base na variável <code class="language-plaintext highlighter-rouge">hosted_zone_id</code> para criar os recursos de chaveamento.</p>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="nx">variable</span> <span class="s2">"route53_hosted_zone"</span> <span class="p">{</span>
  <span class="nx">type</span>    <span class="p">=</span> <span class="nx">string</span>
  <span class="nx">default</span> <span class="p">=</span> <span class="s2">"Z102505525LUE9SZ7HWTY"</span>
<span class="p">}</span>

<span class="nx">variable</span> <span class="s2">"route53_domain"</span> <span class="p">{</span>
  <span class="nx">type</span>    <span class="p">=</span> <span class="nx">string</span>
  <span class="nx">default</span> <span class="p">=</span> <span class="s2">"msfidelis.com.br"</span>
<span class="p">}</span>

<span class="nx">variable</span> <span class="s2">"api_gateway_domain"</span> <span class="p">{</span>
  <span class="nx">type</span>    <span class="p">=</span> <span class="nx">string</span>
  <span class="nx">default</span> <span class="p">=</span> <span class="s2">"api.msfidelis.com.br"</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><br></p>

<h3 id="chaveamento-entre-as-regiões-da-aws">Chaveamento entre as Regiões da AWS</h3>

<p>Com base nas premissas iniciais, a proposta é fornecer um chaveamento simples, no qual apenas um commit, uma rodada de pipeline, um apply, seja possível redirecionar todo o tráfego para uma ou outra região de DR.</p>

<p>Vamos manipular uma variável chamada <code class="language-plaintext highlighter-rouge">state</code>, onde em cada chave de região vamos manter as strings <code class="language-plaintext highlighter-rouge">ACTIVE</code> e <code class="language-plaintext highlighter-rouge">PASSIVE</code>. Com base nesses valores vamos decidir muita coisa.</p>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="nx">variable</span> <span class="s2">"state"</span> <span class="p">{</span>
  <span class="nx">type</span> <span class="p">=</span> <span class="nx">map</span><span class="p">(</span><span class="nx">any</span><span class="p">)</span>
  <span class="nx">default</span> <span class="p">=</span> <span class="p">{</span>
    <span class="s2">"sa-east-1"</span> <span class="err">:</span> <span class="s2">"ACTIVE"</span><span class="p">,</span>
    <span class="s2">"us-east-1"</span> <span class="err">:</span> <span class="s2">"PASSIVE"</span><span class="p">,</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Com base no valor dessa variável, podemos definir por exemplo o quanto queremos setar de peso entre os&nbsp;records</p>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nx">lookup</span><span class="err">(</span><span class="nx">var</span><span class="err">.</span><span class="nx">state</span><span class="err">,</span> <span class="s2">"região"</span><span class="err">)</span> <span class="err">==</span> <span class="s2">"ACTIVE"</span> <span class="err">?</span> <span class="mi">100</span> <span class="err">:</span> <span class="mi">0</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Com base no valor <code class="language-plaintext highlighter-rouge">ACTIVE</code>, podemos configurar no Route53 um redirecionamento com <code class="language-plaintext highlighter-rouge">weight policy</code> de peso 100, e para o valor <code class="language-plaintext highlighter-rouge">PASSIVE</code> um peso 0. Invertendo os valores dessas variáveis, temos a flexibilidade de desabilitar o roteamento de DNS da região <code class="language-plaintext highlighter-rouge">sa-east-1</code> e direcionar todo o tráfego para <code class="language-plaintext highlighter-rouge">us-east-1</code>, conforme os pesos atribuídos.</p>

<p>Adicionalmente, é viável configurar ambas as regiões como <code class="language-plaintext highlighter-rouge">ACTIVE</code>, o que possibilita a implementação de um balanceamento Round Robin na resolução de nomes, distribuindo as cargas de trabalho entre as duas regiões de forma equilibrada.</p>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
</pre></td><td class="rouge-code"><pre><span class="nx">resource</span> <span class="s2">"aws_route53_record"</span> <span class="s2">"primary"</span> <span class="p">{</span>

  <span class="nx">provider</span> <span class="p">=</span> <span class="nx">aws</span><span class="p">.</span><span class="nx">primary</span>

  <span class="nx">zone_id</span> <span class="p">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">route53_hosted_zone</span>
  <span class="nx">name</span>    <span class="p">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">api_gateway_domain</span>
  <span class="nx">type</span>    <span class="p">=</span> <span class="s2">"A"</span>

  <span class="nx">weighted_routing_policy</span> <span class="p">{</span> <span class="err">&lt;</span><span class="nx">-------------</span>
    <span class="nx">weight</span> <span class="p">=</span> <span class="nx">lookup</span><span class="p">(</span><span class="nx">var</span><span class="p">.</span><span class="nx">state</span><span class="p">,</span> <span class="s2">"sa-east-1"</span><span class="p">)</span> <span class="p">==</span> <span class="s2">"ACTIVE"</span> <span class="err">?</span> <span class="mi">100</span> <span class="err">:</span> <span class="mi">0</span>
  <span class="p">}</span>

  <span class="nx">set_identifier</span> <span class="p">=</span> <span class="s2">"primary"</span>

  <span class="nx">alias</span> <span class="p">{</span>
    <span class="nx">evaluate_target_health</span> <span class="p">=</span> <span class="kc">true</span>
    <span class="nx">name</span>                   <span class="p">=</span> <span class="nx">module</span><span class="p">.</span><span class="nx">custom_domain_sa_east_1</span><span class="p">.</span><span class="nx">regional_domain_name</span>
    <span class="nx">zone_id</span>                <span class="p">=</span> <span class="nx">module</span><span class="p">.</span><span class="nx">custom_domain_sa_east_1</span><span class="p">.</span><span class="nx">regional_zone_id</span>
  <span class="p">}</span>
<span class="p">}</span>


<span class="nx">resource</span> <span class="s2">"aws_route53_record"</span> <span class="s2">"dr"</span> <span class="p">{</span>

  <span class="nx">provider</span> <span class="p">=</span> <span class="nx">aws</span><span class="p">.</span><span class="nx">disaster-recovery</span>

  <span class="nx">zone_id</span> <span class="p">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">route53_hosted_zone</span>
  <span class="nx">name</span>    <span class="p">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">api_gateway_domain</span>
  <span class="nx">type</span>    <span class="p">=</span> <span class="s2">"A"</span>

  <span class="nx">weighted_routing_policy</span> <span class="p">{</span> <span class="err">&lt;</span><span class="nx">-------------</span>
    <span class="nx">weight</span> <span class="p">=</span> <span class="nx">lookup</span><span class="p">(</span><span class="nx">var</span><span class="p">.</span><span class="nx">state</span><span class="p">,</span> <span class="s2">"us-east-1"</span><span class="p">)</span> <span class="p">==</span> <span class="s2">"ACTIVE"</span> <span class="err">?</span> <span class="mi">100</span> <span class="err">:</span> <span class="mi">0</span>
  <span class="p">}</span>

  <span class="nx">set_identifier</span> <span class="p">=</span> <span class="s2">"disaster-recovery"</span>

  <span class="nx">alias</span> <span class="p">{</span>
    <span class="nx">evaluate_target_health</span> <span class="p">=</span> <span class="kc">true</span>
    <span class="nx">name</span>                   <span class="p">=</span> <span class="nx">module</span><span class="p">.</span><span class="nx">custom_domain_us_east_1</span><span class="p">.</span><span class="nx">regional_domain_name</span>
    <span class="nx">zone_id</span>                <span class="p">=</span> <span class="nx">module</span><span class="p">.</span><span class="nx">custom_domain_us_east_1</span><span class="p">.</span><span class="nx">regional_zone_id</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><br></p>

<h4 id="exemplo-do-dr-desligado">Exemplo do DR desligado</h4>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="nx">variable</span> <span class="s2">"state"</span> <span class="p">{</span>
  <span class="nx">type</span> <span class="p">=</span> <span class="nx">map</span><span class="p">(</span><span class="nx">any</span><span class="p">)</span>
  <span class="nx">default</span> <span class="p">=</span> <span class="p">{</span>
    <span class="s2">"sa-east-1"</span> <span class="err">:</span> <span class="s2">"ACTIVE"</span><span class="p">,</span>
    <span class="s2">"us-east-1"</span> <span class="err">:</span> <span class="s2">"PASSIVE"</span><span class="p">,</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<figure><img alt="" src="https://cdn-images-1.medium.com/max/1024/1*tmHxxVbrxpVkCOWN3ySd_g.png"></figure>

<p><br></p>

<h4 id="exemplo-do-drligado">Exemplo do DR&nbsp;Ligado</h4>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="nx">variable</span> <span class="s2">"state"</span> <span class="p">{</span>
  <span class="nx">type</span> <span class="p">=</span> <span class="nx">map</span><span class="p">(</span><span class="nx">any</span><span class="p">)</span>
  <span class="nx">default</span> <span class="p">=</span> <span class="p">{</span>
    <span class="s2">"sa-east-1"</span> <span class="err">:</span> <span class="s2">"PASSIVE"</span><span class="p">,</span>
    <span class="s2">"us-east-1"</span> <span class="err">:</span> <span class="s2">"ACTIVE"</span><span class="p">,</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<figure><img alt="" src="https://cdn-images-1.medium.com/max/1024/1*9YP2fX4lwsr1bTS5NrtJwg.png"></figure>

<p><br></p>

<h4 id="exemplo-do-dr-ativoativo">Exemplo do DR Ativo/Ativo</h4>

<figure><img alt="" src="https://cdn-images-1.medium.com/max/1024/1*gWMOe0BnhaoPgAXtshzgkA.png"></figure>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="nx">variable</span> <span class="s2">"state"</span> <span class="p">{</span>
  <span class="nx">type</span> <span class="p">=</span> <span class="nx">map</span><span class="p">(</span><span class="nx">any</span><span class="p">)</span>
  <span class="nx">default</span> <span class="p">=</span> <span class="p">{</span>
    <span class="s2">"sa-east-1"</span> <span class="err">:</span> <span class="s2">"ACTIVE"</span><span class="p">,</span>
    <span class="s2">"us-east-1"</span> <span class="err">:</span> <span class="s2">"ACTIVE"</span><span class="p">,</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><br></p>

<h1 id="parte-2-computing">Parte 2: Computing</h1>

<p>Parte crucial pra uma estratégia de DR funcionar, é escolher como rodar nossas aplicações. Essa decisão precisa levar em conta o quão replicável a forma como publicamos e fazemos a governança desses serviços é. No o modelo computacional que cabe como uma luva são <strong>containers</strong>, e principalmente opções <strong>Serverless</strong> como o <strong>AWS Lambda</strong>, e na intersecção entre os dois modelos, o AWS Fargate que tem opções de rodar no modelo de <strong>EKS (<em>Elastic Kubernetes Service</em>)</strong> e de <strong>ECS</strong> <strong>(<em>Elastic Container Service</em>)</strong>.</p>

<p>Como você vai fazer e qual modelo e tecnologia você vai usar é necessário uma análise cuidadosa a respeito das skills do time e do nível de complexidade que você quer atingir ou evitar com sua arquitetura no fim do dia. Neste exemplo vamos utilizar containers, rodando em <strong>ECS Fargate</strong>. Poderia ser um EKS, Nomad, o Próprio Lambda tranquilamente. O importante é que consigamos replicar nosso serviço em qualquer lugar, isso inclui poder parametrizar os recursos externos por meio de variáveis ambiente, gestão de secrets para que o serviço em si funcione de forma padronizada, porém consumindo diferentes recursos em diferentes apontamentos.</p>

<p><a href="https://github.com/msfidelis/aws-multi-region-disaster-recovery">A partir daqui vou reduzir os exemplos de código, porém você pode acompanhar tudo que foi desenvolvido nessa PoC através deste repo</a>, e vou deixando pontualmente os links para os respectivos módulos.</p>

<p><a href="https://github.com/msfidelis/aws-multi-region-disaster-recovery/tree/main/modules/cluster">Modulo do Cluster ECS Disponível Aqui</a></p>

<p><a href="https://github.com/msfidelis/aws-multi-region-disaster-recovery/tree/main/modules/service">Modulo do Service ECS Disponível Aqui</a></p>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
</pre></td><td class="rouge-code"><pre><span class="nx">module</span> <span class="s2">"cluster_sa_east_1"</span> <span class="p">{</span>
  <span class="nx">source</span> <span class="p">=</span> <span class="s2">"./modules/cluster"</span>

  <span class="nx">providers</span> <span class="p">=</span> <span class="p">{</span>
    <span class="nx">aws</span> <span class="p">=</span> <span class="nx">aws</span><span class="p">.</span><span class="nx">primary</span>
  <span class="p">}</span>

  <span class="nx">cluster_name</span> <span class="p">=</span> <span class="s2">"my-demo"</span>

  <span class="nx">vpc_id</span>               <span class="p">=</span> <span class="nx">module</span><span class="p">.</span><span class="nx">vpc_sa_east_1</span><span class="p">.</span><span class="nx">vpc_id</span>
  <span class="nx">subnets</span>              <span class="p">=</span> <span class="nx">module</span><span class="p">.</span><span class="nx">vpc_sa_east_1</span><span class="p">.</span><span class="nx">private_subnets</span>
  <span class="nx">route53_private_zone</span> <span class="p">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">route53_private_zone</span>

<span class="p">}</span>

<span class="c1">// ... </span>

<span class="nx">module</span> <span class="s2">"app_demo_sa_east_1"</span> <span class="p">{</span>
  <span class="nx">source</span> <span class="p">=</span> <span class="s2">"./modules/service"</span>

  <span class="nx">providers</span> <span class="p">=</span> <span class="p">{</span>
    <span class="nx">aws</span> <span class="p">=</span> <span class="nx">aws</span><span class="p">.</span><span class="nx">primary</span>
  <span class="p">}</span>

  <span class="nx">vpc_id</span> <span class="p">=</span> <span class="nx">module</span><span class="p">.</span><span class="nx">vpc_sa_east_1</span><span class="p">.</span><span class="nx">vpc_id</span>

  <span class="nx">cluster_name</span> <span class="p">=</span> <span class="nx">module</span><span class="p">.</span><span class="nx">cluster_sa_east_1</span><span class="p">.</span><span class="nx">cluster_name</span>
  <span class="nx">route53_zone</span> <span class="p">=</span> <span class="nx">module</span><span class="p">.</span><span class="nx">cluster_sa_east_1</span><span class="p">.</span><span class="nx">private_zone</span>

  <span class="nx">service_name</span>  <span class="p">=</span> <span class="s2">"sales-api"</span>
  <span class="nx">service_image</span> <span class="p">=</span> <span class="s2">"fidelissauro/sales-rest-api:latest"</span>

  <span class="nx">service_port</span> <span class="p">=</span> <span class="mi">8080</span>
  <span class="nx">service_hostname</span> <span class="p">=</span> <span class="p">[</span>
    <span class="nx">format</span><span class="p">(</span><span class="s2">"app-demo.%s"</span><span class="p">,</span> <span class="nx">var</span><span class="p">.</span><span class="nx">route53_private_zone</span><span class="p">)</span>
  <span class="p">]</span>

<span class="c1">// ...</span>

  <span class="nx">envs</span> <span class="p">=</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="nx">name</span> <span class="err">:</span> <span class="s2">"AWS_REGION"</span><span class="p">,</span>
      <span class="nx">value</span> <span class="err">:</span> <span class="s2">"sa-east-1"</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="nx">name</span> <span class="err">:</span> <span class="s2">"DYNAMO_SALES_TABLE"</span><span class="p">,</span>
      <span class="nx">value</span> <span class="err">:</span> <span class="nx">aws_dynamodb_table</span><span class="p">.</span><span class="nx">sales</span><span class="p">.</span><span class="nx">name</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="nx">name</span> <span class="err">:</span> <span class="s2">"SNS_SALES_PROCESSING_TOPIC"</span><span class="p">,</span>
      <span class="nx">value</span> <span class="err">:</span> <span class="nx">module</span><span class="p">.</span><span class="nx">sales_sns_sa_east_1</span><span class="p">.</span><span class="nx">arn</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="nx">name</span> <span class="err">:</span> <span class="s2">"SSM_PARAMETER_STORE_STATE"</span><span class="p">,</span>
      <span class="nx">value</span> <span class="err">:</span> <span class="nx">module</span><span class="p">.</span><span class="nx">ssm_parameter_state_sa_east_1</span><span class="p">.</span><span class="nx">name</span>
    <span class="p">}</span>
  <span class="p">]</span>

<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><br></p>

<h1 id="parte-3-dados---a-real-dificuldade">Parte 3: Dados - A real dificuldade</h1>

<p>Talvez a parte mais importante e complexa de todo plano de <strong>Disaster Recovery</strong>, trabalhar com os dados.</p>

<p>É fundamental garantir a integridade dos dados durante o processo de recuperação. Os dados devem ser replicados ou backup em tempo real para garantir que não haja perda ou corrupção de dados durante uma interrupção.</p>

<p>E mais difícil que virar para o DR, e garantir que os dados estarão lá disponíveis para serem consumidos, mesmo que com algum delay ou com consistência eventual, <strong>é voltar ao estado original.</strong></p>

<p>Voltar ao Site/Região/DC primário com os dados que foram alterados durante o tempo de atividade da Região de DR é extremamente complexo, porém dentro do ferramental que a AWS nos dispõe é razoavelmente simples se tomarmos as decisões arquiteturais corretas.</p>

<p>Nessa parte do artigo, vamos detalhar como criar um fluxo de dados resiliente e eficiente, pensando em <strong>replicação bilateral de todas as fontes de dados</strong>, <strong>offload de processamento, mensageria e eventos</strong>, tudo pensado para que exista uma sincronia e replicação com tempo considerável das duas regiões, para que seja possível chavear, deschavear e manter as duas ativas ofertando os mesmos dados de ambas as partes.</p>

<p>Nesse parte vamos tornar possível:</p>
<ul>
  <li><strong>SNS e SQS Multi-Region</strong></li>
  <li><strong>DynamoDB Global Tables</strong></li>
  <li><strong>Two-way replication no S3</strong></li>
</ul>

<p>No final, iremos chegar em uma solução parecida com essa entre as duas Regiões.</p>

<p><img src="https://cdn-images-1.medium.com/max/1024/1*YoRNqCoGB4VhFSYTg8ujuA.png" alt="Diagrama de solução DR" title="Solução de Disaster Recovery"></p>

<p><br></p>

<h2 id="31eventos-e-mensageria-sns-e-sqs-multi-region">3.1 — Eventos e Mensageria; SNS e SQS Multi Region</h2>

<p>No nosso fluxo hipotético presume que nossa aplicação REST, durante o registro de uma venda, salve um registro de venda no Dynamo, publique uma mensagem para processamento posterior desse item. Para essa solução vamos inserir um fluxo:</p>
<ul>
  <li><strong>App REST -&gt; SNS Topic -&gt; SQS Queue -&gt; Aplicação Worker -&gt; Dynamo</strong></li>
</ul>

<p>Porém para garantir as premissas de replicação, e garantir que uma mensagem recebida por uma região seja replicada automaticamente para a outra, precisamos fazer uso do <strong>SNS Cross-Region Delivery</strong>.</p>

<p>O <strong>SNS Cross-Region Delivery</strong> (Entrega Inter-regional do SNS) é um recurso fornecido pelo Amazon Simple Notification Service (SNS) que permite enviar notificações entre regiões na AWS. O SNS é um serviço gerenciado pela AWS que permite enviar mensagens para várias plataformas, como aplicativos móveis, e-mails, SMS e endpoints HTTP, e neste caso, o <strong>Amazon SQS</strong>, e essa configuração deve ser feita de forma bilateral, em ambos os tópicos SNS e ambas as filas SQS.</p>

<p><img src="https://cdn-images-1.medium.com/max/1024/1*LjkZI8ksvjerhKYJ4v1TrA.png" alt="Configuração SNS Cross-Region" title="Configuração SNS Cross-Region"></p>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre></td><td class="rouge-code"><pre><span class="nx">resource</span> <span class="s2">"aws_sqs_queue_policy"</span> <span class="s2">"main"</span> <span class="p">{</span>
  <span class="nx">queue_url</span> <span class="p">=</span> <span class="nx">aws_sqs_queue</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">policy</span>    <span class="p">=</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": "*",
      "Action": [
        "sqs:SendMessage"
      ],
      "Resource": [
        "${aws_sqs_queue.main.arn}"
      ],
      "Condition": {
        "ArnLike": {
          "aws:SourceArn": [
            "arn:aws:sns:sa-east-1:${data.aws_caller_identity.current.account_id}:${var.sns_topic_name}",
            "arn:aws:sns:us-east-1:${data.aws_caller_identity.current.account_id}:${var.sns_topic_name}"
          ]
        }
      }
    }
  ]
}
</span><span class="no">EOF
</span><span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="nx">resource</span> <span class="s2">"aws_sqs_queue"</span> <span class="s2">"main"</span> <span class="p">{</span>
  <span class="nx">name</span>                      <span class="p">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">queue_name</span>
  <span class="nx">delay_seconds</span>             <span class="p">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">delay_seconds</span>
  <span class="nx">max_message_size</span>          <span class="p">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">max_message_size</span>
  <span class="nx">message_retention_seconds</span> <span class="p">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">message_retention_seconds</span>
  <span class="nx">receive_wait_time_seconds</span> <span class="p">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">receive_wait_time_seconds</span>
  <span class="nx">visibility_timeout_seconds</span> <span class="p">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">visibility_timeout_seconds</span>
  <span class="nx">redrive_policy</span> <span class="p">=</span> <span class="nx">jsonencode</span><span class="p">({</span>
    <span class="nx">deadLetterTargetArn</span> <span class="p">=</span> <span class="nx">aws_sqs_queue</span><span class="p">.</span><span class="nx">dlq</span><span class="p">.</span><span class="nx">arn</span>
    <span class="nx">maxReceiveCount</span>     <span class="p">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">dlq_redrive_max_receive_count</span>
  <span class="p">})</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>E em seguida criar um tópico SNS fazendo subscribe das filas de&nbsp;SQS</p>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="rouge-code"><pre><span class="nx">resource</span> <span class="s2">"aws_sns_topic"</span> <span class="s2">"main"</span> <span class="p">{</span>
  <span class="nx">name</span> <span class="p">=</span> <span class="nx">format</span><span class="p">(</span><span class="s2">"%s"</span><span class="p">,</span> <span class="nx">var</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span>
  <span class="c1">#   fifo_topic                  = true</span>
  <span class="c1">#   content_based_deduplication = true</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_sns_topic_subscription"</span> <span class="s2">"primary"</span> <span class="p">{</span>
  <span class="nx">protocol</span>             <span class="p">=</span> <span class="s2">"sqs"</span>
  <span class="nx">raw_message_delivery</span> <span class="p">=</span> <span class="kc">true</span>
  <span class="nx">topic_arn</span>            <span class="p">=</span> <span class="nx">aws_sns_topic</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">arn</span>
  <span class="nx">endpoint</span>             <span class="p">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">sqs_queue</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_sns_topic_subscription"</span> <span class="s2">"replica"</span> <span class="p">{</span>
  <span class="nx">protocol</span>             <span class="p">=</span> <span class="s2">"sqs"</span>
  <span class="nx">raw_message_delivery</span> <span class="p">=</span> <span class="kc">true</span>
  <span class="nx">topic_arn</span>            <span class="p">=</span> <span class="nx">aws_sns_topic</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">arn</span>
  <span class="nx">endpoint</span>             <span class="p">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">sqs_queue_replica</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Fechando um pouco o capô do carro, e ligando ele pra botar pra funcionar, nossa declaração de módulos trabalharia de forma com que ambas as declarações dos providers recebesse respectivamente qual seria a queue primária e a replica, alternando entre ambos.</p>

<p><a href="https://github.com/msfidelis/aws-multi-region-disaster-recovery/tree/main/modules/sqs-queue" title="Módulo do SQS">Módulo do SQS disponível aqui</a></p>

<p><a href="https://github.com/msfidelis/aws-multi-region-disaster-recovery/tree/main/modules/sns-multiregion-sqs-delivery" title="Módulo do SNS">Módulo do SNS disponível aqui</a></p>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre></td><td class="rouge-code"><pre><span class="nx">module</span> <span class="s2">"sales_processing_queue_sa_east_1"</span> <span class="p">{</span>
  <span class="nx">source</span> <span class="p">=</span> <span class="s2">"./modules/sqs-queue"</span>

  <span class="nx">providers</span> <span class="p">=</span> <span class="p">{</span>
    <span class="nx">aws</span> <span class="p">=</span> <span class="nx">aws</span><span class="p">.</span><span class="nx">primary</span>
  <span class="p">}</span>

  <span class="nx">queue_name</span>                    <span class="p">=</span> <span class="s2">"sales-processing-queue"</span>
  <span class="nx">delay_seconds</span>                 <span class="p">=</span> <span class="mi">0</span>
  <span class="nx">max_message_size</span>              <span class="p">=</span> <span class="mi">2048</span>
  <span class="nx">message_retention_seconds</span>     <span class="p">=</span> <span class="mi">86400</span>
  <span class="nx">receive_wait_time_seconds</span>     <span class="p">=</span> <span class="mi">10</span>
  <span class="nx">dlq_redrive_max_receive_count</span> <span class="p">=</span> <span class="mi">4</span>
  <span class="nx">visibility_timeout_seconds</span>    <span class="p">=</span> <span class="mi">60</span>

  <span class="nx">sns_topic_name</span> <span class="p">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">sales_sns_topic_name</span>
<span class="p">}</span>

<span class="c1">//..</span>

<span class="nx">module</span> <span class="s2">"sales_sns_sa_east_1"</span> <span class="p">{</span>
  <span class="nx">source</span> <span class="p">=</span> <span class="s2">"./modules/sns-multiregion-sqs-delivery"</span>

  <span class="nx">providers</span> <span class="p">=</span> <span class="p">{</span>
    <span class="nx">aws</span> <span class="p">=</span> <span class="nx">aws</span><span class="p">.</span><span class="nx">primary</span>
  <span class="p">}</span>

  <span class="nx">name</span>              <span class="p">=</span> <span class="s2">"sales-processing-topic"</span>
  <span class="nx">sqs_queue</span>         <span class="p">=</span> <span class="nx">module</span><span class="p">.</span><span class="nx">sales_processing_queue_sa_east_1</span><span class="p">.</span><span class="nx">sqs_queue_arn</span>
  <span class="nx">sqs_queue_replica</span> <span class="p">=</span> <span class="nx">module</span><span class="p">.</span><span class="nx">sales_processing_queue_us_east_1</span><span class="p">.</span><span class="nx">sqs_queue_arn</span>
<span class="p">}</span>
<span class="c1">// ...</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Independente do uso de um modulo, desse modulo, de outro modulo, ou fazer na mão, o esperado é que o tópico SNS tenha sempre duas subscriptions, para as queues das duas regiões como no print a seguir, e a devida subscription do SNS de cada região deve aparecer nas configurações das duas filas SQS mostradas.</p>

<p><img src="https://cdn-images-1.medium.com/max/1024/1*06RcwsW06XRV3q3rq1tIcA.png" alt="SNS Topic Subscriptions">
<img src="https://cdn-images-1.medium.com/max/1024/1*avBnof9YXpKzz9xV2YDDPw.png" alt="SQS Queue Configuration 1">
<img src="https://cdn-images-1.medium.com/max/1024/1*0OHoHNjKXCrx3Vr3J0oI-g.png" alt="SQS Queue Configuration 2"></p>

<p><br></p>

<h2 id="32dynamodb-global-tables">3.2 — DynamoDB Global Tables</h2>

<p>As <strong>DynamoDB Global Tables</strong> (Tabelas Globais do DynamoDB) são uma funcionalidade do serviço que permitem que você crie e mantenha tabelas do DynamoDB automaticamente replicadas e sincronizadas em várias regiões da AWS. Perfeito para nossa proposta de DR.</p>

<p>Com as <strong>DynamoDB Global Tables</strong>, você pode ter cópias de tabelas em várias regiões da AWS, garantindo replicação e failover automático, permitindo que as apps leiam e gravem dados de forma local em cada região.</p>

<p><img src="https://cdn-images-1.medium.com/max/802/0*oZA9-EvfRP-wUe6e.png" alt="DynamoDB Global Tables"></p>

<p>Elas são particularmente úteis quando você precisa espelhar sua aplicação entre diversas regiões e disponibilizá-las paralelamente, utilizando a mesma base de dados.</p>

<p>Por exemplo, em caso de <strong>Weighted Routing Policy</strong> utilizado neste exemplo entre Regiões, onde teremos <strong>Round Robin</strong> do consumo de recursos em caso de ACTIVE/ACTIVE, ou num caso legal as <strong>Geolocation routing policy</strong>, onde você pode disponibilizar o workload geograficamente mais proximo do cliente, por exemplo:</p>

<ul>
  <li>Quem está no Brasil, acessa São Paulo</li>
  <li>Quem está em Miami, acessa Virginia</li>
</ul>

<p>Mas no nosso caso de Disaster Recovery, podemos contar que teremos um banco de dados replicado de forma bilateral com baixa latência e consistência eventual, independente das regiões que eu estiver manipulando esse dado.</p>

<p>O provisionamento de uma <strong>Global Table</strong> é simples, e não requer provisionamento duplicado com base em módulos, por isso não iremos fazer uso desse artifício nesse recurso.</p>

<p>Os pontos de atenção para o provisonamento adequado é a necessidade de habilitar o <strong>DynamoDB Streams</strong> no provisionamento da tabela informando o valor booleano no parâmetro <code class="language-plaintext highlighter-rouge">stream_enabled</code> e informando o <code class="language-plaintext highlighter-rouge">stream_view_type</code> como <code class="language-plaintext highlighter-rouge">NEW_AND_OLD_IMAGES</code> para que por meio do stream a replicação aconteça em todas as replicas.</p>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
</pre></td><td class="rouge-code"><pre><span class="nx">resource</span> <span class="s2">"aws_dynamodb_table"</span> <span class="s2">"sales"</span> <span class="p">{</span>

  <span class="nx">provider</span> <span class="p">=</span> <span class="nx">aws</span><span class="p">.</span><span class="nx">primary</span>

  <span class="nx">hash_key</span> <span class="p">=</span> <span class="s2">"id"</span>

  <span class="nx">name</span>             <span class="p">=</span> <span class="s2">"sales"</span>
  <span class="nx">stream_enabled</span>   <span class="p">=</span> <span class="kc">true</span>
  <span class="nx">stream_view_type</span> <span class="p">=</span> <span class="s2">"NEW_AND_OLD_IMAGES"</span>

  <span class="nx">read_capacity</span>  <span class="p">=</span> <span class="nx">lookup</span><span class="p">(</span><span class="nx">var</span><span class="p">.</span><span class="nx">dynamodb_sales</span><span class="p">,</span> <span class="s2">"read_min"</span><span class="p">)</span>
  <span class="nx">write_capacity</span> <span class="p">=</span> <span class="nx">lookup</span><span class="p">(</span><span class="nx">var</span><span class="p">.</span><span class="nx">dynamodb_sales</span><span class="p">,</span> <span class="s2">"write_min"</span><span class="p">)</span>
  <span class="nx">billing_mode</span>   <span class="p">=</span> <span class="nx">lookup</span><span class="p">(</span><span class="nx">var</span><span class="p">.</span><span class="nx">dynamodb_sales</span><span class="p">,</span> <span class="s2">"billing_mode"</span><span class="p">)</span>

  <span class="nx">point_in_time_recovery</span> <span class="p">{</span>
    <span class="nx">enabled</span> <span class="p">=</span> <span class="nx">lookup</span><span class="p">(</span><span class="nx">var</span><span class="p">.</span><span class="nx">dynamodb_sales</span><span class="p">,</span> <span class="s2">"point_in_time_recovery"</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="nx">attribute</span> <span class="p">{</span>
    <span class="nx">name</span> <span class="p">=</span> <span class="s2">"id"</span>
    <span class="nx">type</span> <span class="p">=</span> <span class="s2">"S"</span>
  <span class="p">}</span>

  <span class="nx">server_side_encryption</span> <span class="p">{</span>
    <span class="nx">enabled</span>     <span class="p">=</span> <span class="kc">true</span>
    <span class="nx">kms_key_arn</span> <span class="p">=</span> <span class="nx">module</span><span class="p">.</span><span class="nx">cluster_sa_east_1</span><span class="p">.</span><span class="nx">kms_key</span>
  <span class="p">}</span>


  <span class="nx">lifecycle</span> <span class="p">{</span>
    <span class="nx">ignore_changes</span> <span class="p">=</span> <span class="p">[</span>
      <span class="nx">read_capacity</span><span class="p">,</span>
      <span class="nx">write_capacity</span><span class="p">,</span>
      <span class="nx">replica</span>
    <span class="p">]</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Omitindo configs de autoscaling</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Em seguida precisaremos criar um outro recurso chamado aws_dynamodb_table_replica informando qual tabela será replicada e em qual região. Nesse caso precisaremos informar o provider do terraform da zona de&nbsp;DR.</p>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="nx">resource</span> <span class="s2">"aws_dynamodb_table_replica"</span> <span class="s2">"sales"</span> <span class="p">{</span>
  <span class="nx">provider</span>         <span class="p">=</span> <span class="nx">aws</span><span class="p">.</span><span class="nx">disaster-recovery</span>
  <span class="nx">global_table_arn</span> <span class="p">=</span> <span class="nx">aws_dynamodb_table</span><span class="p">.</span><span class="nx">sales</span><span class="p">.</span><span class="nx">arn</span>

  <span class="nx">kms_key_arn</span>      <span class="p">=</span> <span class="nx">module</span><span class="p">.</span><span class="nx">cluster_us_east_1</span><span class="p">.</span><span class="nx">kms_key</span>

  <span class="nx">depends_on</span> <span class="p">=</span> <span class="p">[</span>
    <span class="nx">aws_appautoscaling_target</span><span class="p">.</span><span class="nx">sales_read</span><span class="p">,</span>
    <span class="nx">aws_appautoscaling_target</span><span class="p">.</span><span class="nx">sales_write</span><span class="p">,</span>
    <span class="nx">aws_appautoscaling_policy</span><span class="p">.</span><span class="nx">sales_read</span><span class="p">,</span>
    <span class="nx">aws_appautoscaling_policy</span><span class="p">.</span><span class="nx">sales_write</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Para testar, vamos consumir nossa API do produto hipotético tentando criar uma venda, em seguida executar um Scan na tabela nas duas regiões para garantir que ele está&nbsp;lá.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre>❯ curl <span class="nt">-X</span> POST https://api.msfidelis.com.br/sales <span class="nt">-d</span> <span class="s1">'{"product":"registro que viajou entre duas regiões", "amount": 666.00}'</span> <span class="nt">-i</span>
HTTP/2 201
<span class="nb">date</span>: Wed, 12 Jul 2023 00:22:26 GMT
content-type: application/json<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>utf-8
content-length: 128
x-amzn-requestid: bb696387-4a2c-46b4-b68c-82adbefc9fd1
x-amzn-remapped-content-length: 128
x-amzn-remapped-connection: keep-alive
x-amz-apigw-id: <span class="nv">H7LKVG88mjQEO6Q</span><span class="o">=</span>
x-amzn-remapped-date: Wed, 12 Jul 2023 00:22:26 GMT

<span class="o">{</span><span class="s2">"id"</span>:<span class="s2">"d2673f99-d632-453d-aedd-13a30fc3bc78"</span>,<span class="s2">"product"</span>:<span class="s2">"registro que viajou entre duas regiões"</span>,<span class="s2">"amount"</span>:666,<span class="s2">"processed"</span>:false<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn-images-1.medium.com/max/1024/1*wNpVfLQASyIRMqKWh3DpPw.png" alt="S3 Two Way Replication Diagram">
<img src="https://cdn-images-1.medium.com/max/1024/1*HRmUBwRSmEN7xSnkjeOpug.png" alt="S3 Replication Configuration"></p>

<p><br></p>

<h2 id="33s3-two-way-replication">3.3 — S3 Two Way Replication</h2>

<p>Nosso produto hipotético, após nosso worker consumir a mensagem no SQS de uma nova venda, ele faz uma série de processamento também hipotético, atualiza a flag de processamento no DynamoDB e em seguida sobe o registro para o S3 para Backup e ingestão futura de um <strong>Data Lake hipotético do Athena. (Não iremos abordar o Amazon Athena por enquanto)</strong></p>

<p>O <strong>Amazon S3 (Simple Storage Service)</strong> é um serviço popular de armazenamento de objetos oferecido pela AWS. Ele fornece uma solução escalável, segura e durável para armazenar e recuperar dados de forma eficiente. Uma das funcionalidades avançadas do Amazon S3 é o <strong>S3 Two Way Replication</strong>, que oferece uma abordagem bidirecional para replicar dados entre buckets do S3 em regiões diferentes.</p>

<p>A <strong>Replicação Bidirecional do S3 Two Way permite a replicação contínua e síncrona dos objetos armazenados em um bucket do S3 para um bucket correspondente em outra região.</strong> Isso significa que qualquer <strong>alteração, inclusão ou exclusão feita em um objeto em um bucket será automaticamente replicada para o bucket de destino em tempo real.</strong> Com essa abordagem, você pode manter cópias atualizadas dos seus dados em regiões distintas, aumentando a disponibilidade e a durabilidade dos objetos armazenados no S3.</p>

<p>Para o nosso objetivo de DR e replicação de dados, essa solução serve muito bem. Podemos escrever e ler dos dois buckets da replicação e contar que ambas as modificações serão espelhadas na região vizinha.</p>

<p>Nesse caso, o provisionamento é bem simples. Vamos também utilizar um módulo onde iremos provisionar dois buckets com as mesmas configurações nas duas regiões, primária e disaster-recovery.</p>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre><span class="nx">module</span> <span class="s2">"bucket_sa_east_1"</span> <span class="p">{</span>
  <span class="nx">source</span> <span class="p">=</span> <span class="s2">"./modules/s3_bucket"</span>

  <span class="nx">providers</span> <span class="p">=</span> <span class="p">{</span>
    <span class="nx">aws</span> <span class="p">=</span> <span class="nx">aws</span><span class="p">.</span><span class="nx">primary</span>
  <span class="p">}</span>

  <span class="nx">bucket_name_prefix</span> <span class="p">=</span> <span class="s2">"processed-sale"</span>
<span class="p">}</span>


<span class="nx">module</span> <span class="s2">"bucket_us_east_1"</span> <span class="p">{</span>
  <span class="nx">source</span> <span class="p">=</span> <span class="s2">"./modules/s3_bucket"</span>

  <span class="nx">providers</span> <span class="p">=</span> <span class="p">{</span>
    <span class="nx">aws</span> <span class="p">=</span> <span class="nx">aws</span><span class="p">.</span><span class="nx">disaster-recovery</span>
  <span class="p">}</span>

  <span class="nx">bucket_name_prefix</span> <span class="p">=</span> <span class="s2">"processed-sale"</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Devemos prepara uma IAM Role que permita ser assumida pelo S3 com as devidas permissões de replicação e manipulação de&nbsp;objetos.</p>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
</pre></td><td class="rouge-code"><pre><span class="c1">// Replication IAM</span>
<span class="nx">data</span> <span class="s2">"aws_iam_policy_document"</span> <span class="s2">"assume_role"</span> <span class="p">{</span>
  <span class="nx">statement</span> <span class="p">{</span>
    <span class="nx">effect</span> <span class="p">=</span> <span class="s2">"Allow"</span>

    <span class="nx">principals</span> <span class="p">{</span>
      <span class="nx">type</span>        <span class="p">=</span> <span class="s2">"Service"</span>
      <span class="nx">identifiers</span> <span class="p">=</span> <span class="p">[</span><span class="s2">"s3.amazonaws.com"</span><span class="p">]</span>
    <span class="p">}</span>

    <span class="nx">actions</span> <span class="p">=</span> <span class="p">[</span><span class="s2">"sts:AssumeRole"</span><span class="p">]</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_iam_role"</span> <span class="s2">"replication"</span> <span class="p">{</span>
  <span class="nx">provider</span>           <span class="p">=</span> <span class="nx">aws</span><span class="p">.</span><span class="nx">primary</span>
  <span class="nx">name</span>               <span class="p">=</span> <span class="nx">format</span><span class="p">(</span><span class="s2">"sales-s3-replication"</span><span class="p">)</span>
  <span class="nx">assume_role_policy</span> <span class="p">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">aws_iam_policy_document</span><span class="p">.</span><span class="nx">assume_role</span><span class="p">.</span><span class="nx">json</span>
<span class="p">}</span>

<span class="nx">data</span> <span class="s2">"aws_iam_policy_document"</span> <span class="s2">"replication"</span> <span class="p">{</span>
  <span class="nx">statement</span> <span class="p">{</span>
    <span class="nx">effect</span> <span class="p">=</span> <span class="s2">"Allow"</span>

    <span class="nx">actions</span> <span class="p">=</span> <span class="p">[</span>
      <span class="s2">"s3:GetReplicationConfiguration"</span><span class="p">,</span>
      <span class="s2">"s3:ListBucket"</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="nx">resources</span> <span class="p">=</span> <span class="p">[</span>
      <span class="nx">module</span><span class="p">.</span><span class="nx">bucket_sa_east_1</span><span class="p">.</span><span class="nx">arn</span><span class="p">,</span>
      <span class="nx">module</span><span class="p">.</span><span class="nx">bucket_us_east_1</span><span class="p">.</span><span class="nx">arn</span><span class="p">,</span>
    <span class="p">]</span>
  <span class="p">}</span>

  <span class="nx">statement</span> <span class="p">{</span>
    <span class="nx">effect</span> <span class="p">=</span> <span class="s2">"Allow"</span>

    <span class="nx">actions</span> <span class="p">=</span> <span class="p">[</span>
      <span class="s2">"s3:GetObjectVersionForReplication"</span><span class="p">,</span>
      <span class="s2">"s3:GetObjectVersionAcl"</span><span class="p">,</span>
      <span class="s2">"s3:GetObjectVersionTagging"</span><span class="p">,</span>
      <span class="s2">"s3:ReplicateObject"</span><span class="p">,</span>
      <span class="s2">"s3:ReplicateDelete"</span><span class="p">,</span>
      <span class="s2">"s3:ReplicateTags"</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="nx">resources</span> <span class="p">=</span> <span class="p">[</span>
      <span class="s2">"${module.bucket_sa_east_1.arn}/*"</span><span class="p">,</span>
      <span class="s2">"${module.bucket_us_east_1.arn}/*"</span>
    <span class="p">]</span>
  <span class="p">}</span>

<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_iam_policy"</span> <span class="s2">"replication"</span> <span class="p">{</span>
  <span class="nx">provider</span> <span class="p">=</span> <span class="nx">aws</span><span class="p">.</span><span class="nx">primary</span>
  <span class="nx">name</span>     <span class="p">=</span> <span class="nx">format</span><span class="p">(</span><span class="s2">"sales-s3-replication"</span><span class="p">)</span>
  <span class="nx">policy</span>   <span class="p">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">aws_iam_policy_document</span><span class="p">.</span><span class="nx">replication</span><span class="p">.</span><span class="nx">json</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_iam_role_policy_attachment"</span> <span class="s2">"replication"</span> <span class="p">{</span>
  <span class="nx">provider</span>   <span class="p">=</span> <span class="nx">aws</span><span class="p">.</span><span class="nx">primary</span>
  <span class="nx">role</span>       <span class="p">=</span> <span class="nx">aws_iam_role</span><span class="p">.</span><span class="nx">replication</span><span class="p">.</span><span class="nx">name</span>
  <span class="nx">policy_arn</span> <span class="p">=</span> <span class="nx">aws_iam_policy</span><span class="p">.</span><span class="nx">replication</span><span class="p">.</span><span class="nx">arn</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Podemos duplicar o recurso aws_s3_bucket_replication_configuration alternando em cada um o bucket origem e&nbsp;destino.</p>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
</pre></td><td class="rouge-code"><pre><span class="nx">resource</span> <span class="s2">"aws_s3_bucket_replication_configuration"</span> <span class="s2">"primary"</span> <span class="p">{</span>

  <span class="nx">provider</span> <span class="p">=</span> <span class="nx">aws</span><span class="p">.</span><span class="nx">primary</span>

  <span class="nx">role</span>   <span class="p">=</span> <span class="nx">aws_iam_role</span><span class="p">.</span><span class="nx">replication</span><span class="p">.</span><span class="nx">arn</span>
  <span class="nx">bucket</span> <span class="p">=</span> <span class="nx">module</span><span class="p">.</span><span class="nx">bucket_sa_east_1</span><span class="p">.</span><span class="nx">id</span>

  <span class="nx">rule</span> <span class="p">{</span>
    <span class="nx">id</span> <span class="p">=</span> <span class="s2">"sales"</span>

    <span class="nx">filter</span> <span class="p">{</span>
      <span class="nx">prefix</span> <span class="p">=</span> <span class="s2">"sales"</span>
    <span class="p">}</span>

    <span class="nx">delete_marker_replication</span> <span class="p">{</span>
      <span class="nx">status</span> <span class="p">=</span> <span class="s2">"Enabled"</span>
    <span class="p">}</span>

    <span class="nx">status</span> <span class="p">=</span> <span class="s2">"Enabled"</span>

    <span class="nx">destination</span> <span class="p">{</span>
      <span class="nx">bucket</span>        <span class="p">=</span> <span class="nx">module</span><span class="p">.</span><span class="nx">bucket_us_east_1</span><span class="p">.</span><span class="nx">arn</span>
      <span class="nx">storage_class</span> <span class="p">=</span> <span class="s2">"STANDARD"</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>


<span class="nx">resource</span> <span class="s2">"aws_s3_bucket_replication_configuration"</span> <span class="s2">"disaster_recovery"</span> <span class="p">{</span>

  <span class="nx">provider</span> <span class="p">=</span> <span class="nx">aws</span><span class="p">.</span><span class="nx">disaster-recovery</span>

  <span class="nx">role</span>   <span class="p">=</span> <span class="nx">aws_iam_role</span><span class="p">.</span><span class="nx">replication</span><span class="p">.</span><span class="nx">arn</span>
  <span class="nx">bucket</span> <span class="p">=</span> <span class="nx">module</span><span class="p">.</span><span class="nx">bucket_us_east_1</span><span class="p">.</span><span class="nx">id</span>

  <span class="nx">rule</span> <span class="p">{</span>
    <span class="nx">id</span> <span class="p">=</span> <span class="s2">"sales"</span>

    <span class="nx">filter</span> <span class="p">{</span>
      <span class="nx">prefix</span> <span class="p">=</span> <span class="s2">"sales"</span>
    <span class="p">}</span>

    <span class="nx">delete_marker_replication</span> <span class="p">{</span>
      <span class="nx">status</span> <span class="p">=</span> <span class="s2">"Enabled"</span>
    <span class="p">}</span>

    <span class="nx">status</span> <span class="p">=</span> <span class="s2">"Enabled"</span>

    <span class="nx">destination</span> <span class="p">{</span>
      <span class="nx">bucket</span>        <span class="p">=</span> <span class="nx">module</span><span class="p">.</span><span class="nx">bucket_sa_east_1</span><span class="p">.</span><span class="nx">arn</span>
      <span class="nx">storage_class</span> <span class="p">=</span> <span class="s2">"STANDARD"</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Vamos consumir novamente a aplicação inserindo um novo hipotético registro de venda de um&nbsp;produto.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre>❯ curl <span class="nt">-X</span> POST https://api.msfidelis.com.br/sales <span class="nt">-d</span> <span class="s1">'{"product":"registro que viajou entre duas regiões e caiu em dois buckets", "amount": 333.00}'</span> <span class="nt">-i</span>
HTTP/2 201
<span class="nb">date</span>: Wed, 12 Jul 2023 00:44:43 GMT
content-type: application/json<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>utf-8
content-length: 151
x-amzn-requestid: 7194a8c3-e4f1-48f2-baea-77c347174130
x-amzn-remapped-content-length: 151
x-amzn-remapped-connection: keep-alive
x-amz-apigw-id: <span class="nv">H7ObVER4mjQEH_w</span><span class="o">=</span>
x-amzn-remapped-date: Wed, 12 Jul 2023 00:44:43 GMT

<span class="o">{</span><span class="s2">"id"</span>:<span class="s2">"db218024-3974-4ad7-9490-2c88560298de"</span>,<span class="s2">"product"</span>:<span class="s2">"registro que viajou entre duas regiões e caiu em dois buckets"</span>,<span class="s2">"amount"</span>:333,<span class="s2">"processed"</span>:false<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Agora vamos conferir no bucket se existe o registro <strong><em>db218024-3974-4ad7-9490-2c88560298de.json</em></strong> em ambas as regiões.</p>

<p><img src="https://cdn-images-1.medium.com/max/921/1*GPETUjCT8_FFcDAbwVlDXA.png" alt="Bucket Check Region 1"></p>

<p><img src="https://cdn-images-1.medium.com/max/928/1*jQSTYJjxjq7JWrAv-157vQ.png" alt="Bucket Check Region 2"></p>

<p><br></p>

<h1 id="parte-4-escrevendo-código-multi-region-e-sugestões-arquiteturais">Parte 4: Escrevendo Código Multi Region e Sugestões Arquiteturais</h1>

<p>Achou mesmo que é só subir infra que resolve? Achou errado, amigo.</p>

<p>Trabalhar em Multiregião é uma escolha, um projeto, um objetivo, não um hotfix, então devemos trabalhar nossas aplicações para que as mesmas sejam resilientes não só a falhas mas também para trabalhar de forma inteligente esse chaveamento de regiões. Temos diversos padrões que podem nos ajudar, nesse artigo trabalharemos os seguintes:</p>

<ul>
  <li>Feature Toggle com Parameter Store</li>
  <li>Dry-Run</li>
  <li>Idempotência</li>
</ul>

<p><br></p>

<h2 id="41--feature-toggle-com-parameter-store">4.1 — Feature Toggle com Parameter Store</h2>

<p>Um <strong>Feature Toggle</strong>, também conhecido como <strong>Feature Flag</strong> dependendo pra quem você pergunta, é um mecanismo de controle que permite <strong>habilitar ou desabilitar recursos ou funcionalidades específicas em um software</strong>, sem a necessidade de fazer uma nova implantação ou alteração na codebase. É uma técnica comumente utilizada no desenvolvimento de software para ativar ou desativar recursos de forma flexível e controlada, possibilitando a entrega contínua e incremental de novas funcionalidades.</p>

<p>Com um <strong>Feature Toggle</strong>, você pode ocultar uma funcionalidade em produção enquanto ainda está em desenvolvimento, permitindo que você teste, experimente e valide essa funcionalidade em um ambiente de produção controlado.</p>

<p>No nosso caso, iremos utilizá-lo para desabilitar ou habilitar o processamento inteiro de uma região e das aplicações que compõe o nosso Workload de vendas em tempo de DR.</p>

<p>O <strong>Parameter Store</strong> é um serviço gerenciado pela AWS que <strong>oferece armazenamento seguro e gerenciamento de parâmetros e configurações.</strong> Ele permite armazenar e recuperar informações sensíveis, como senhas, chaves, strings de conexão e outros valores de configuração, de forma centralizada e segura.</p>

<p>Uma forma inteligente de trabalhar com Feature Toggle no Parameter Store é fazer com que <strong>pragmaticamente, a aplicação sempre consulte o valor do parâmetro de X em X tempo e salve em memória</strong> por um determinado período de tempo. Sempre que esse registro expirar, a aplicação consiga consultar e atualizar o parâmetro de forma global para o runtime.</p>

<p>Por exemplo, durante uma determinada interação eu consulto o valor do parameter store que contém o valor do estado do meu Site/Região, e digo para salvar essa informação em cache em memória por 30 segundos.</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="n">ssm_site_state_parameter</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">Getenv</span><span class="p">(</span><span class="s">"SSM_PARAMETER_STORE_STATE"</span><span class="p">)</span>
<span class="n">site_state</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">parameter_store</span><span class="o">.</span><span class="n">GetParamValue</span><span class="p">(</span><span class="n">ssm_site_state_parameter</span><span class="p">,</span> <span class="m">30</span><span class="p">)</span> 
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre><span class="k">package</span> <span class="n">memory_cache</span>

<span class="k">import</span> <span class="p">(</span>
	<span class="s">"time"</span>

	<span class="s">"github.com/patrickmn/go-cache"</span>
<span class="p">)</span>

<span class="k">var</span> <span class="n">instance</span> <span class="o">*</span><span class="n">cache</span><span class="o">.</span><span class="n">Cache</span>

<span class="k">func</span> <span class="n">GetInstance</span><span class="p">()</span> <span class="o">*</span><span class="n">cache</span><span class="o">.</span><span class="n">Cache</span> <span class="p">{</span>
	<span class="k">if</span> <span class="n">instance</span> <span class="o">==</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="n">instance</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">New</span><span class="p">(</span><span class="m">5</span><span class="o">*</span><span class="n">time</span><span class="o">.</span><span class="n">Minute</span><span class="p">,</span> <span class="m">10</span><span class="o">*</span><span class="n">time</span><span class="o">.</span><span class="n">Minute</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">instance</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
</pre></td><td class="rouge-code"><pre><span class="k">package</span> <span class="n">parameter_store</span>

<span class="k">import</span> <span class="p">(</span>
	<span class="s">"fmt"</span>
	<span class="s">"os"</span>
	<span class="s">"time"</span>

	<span class="s">"sales-worker/pkg/log"</span>
	<span class="s">"sales-worker/pkg/memory_cache"</span>

	<span class="s">"github.com/aws/aws-sdk-go/aws"</span>
	<span class="s">"github.com/aws/aws-sdk-go/aws/session"</span>
	<span class="s">"github.com/aws/aws-sdk-go/service/ssm"</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">GetParamValue</span><span class="p">(</span><span class="n">parameter</span> <span class="kt">string</span><span class="p">,</span> <span class="n">cacheTime</span> <span class="kt">int64</span><span class="p">)</span> <span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">m</span> <span class="o">:=</span> <span class="n">memory_cache</span><span class="o">.</span><span class="n">GetInstance</span><span class="p">()</span>
	<span class="n">log</span> <span class="o">:=</span> <span class="n">log</span><span class="o">.</span><span class="n">Instance</span><span class="p">()</span>

	<span class="k">if</span> <span class="n">cacheTime</span> <span class="o">&gt;</span> <span class="m">0</span> <span class="p">{</span>
		<span class="k">if</span> <span class="n">value</span><span class="p">,</span> <span class="n">found</span> <span class="o">:=</span> <span class="n">m</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="n">parameter</span><span class="p">);</span> <span class="n">found</span> <span class="p">{</span>
			<span class="n">log</span><span class="o">.</span><span class="n">Info</span><span class="p">(</span><span class="s">"Parameter found in cache"</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Sprint</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="no">nil</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">sess</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">session</span><span class="o">.</span><span class="n">NewSession</span><span class="p">(</span><span class="o">&amp;</span><span class="n">aws</span><span class="o">.</span><span class="n">Config</span><span class="p">{</span>
		<span class="n">Region</span><span class="o">:</span> <span class="n">aws</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">Getenv</span><span class="p">(</span><span class="s">"AWS_REGION"</span><span class="p">)),</span>
	<span class="p">})</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="s">""</span><span class="p">,</span> <span class="n">err</span>
	<span class="p">}</span>

	<span class="n">svc</span> <span class="o">:=</span> <span class="n">ssm</span><span class="o">.</span><span class="n">New</span><span class="p">(</span><span class="n">sess</span><span class="p">)</span>

	<span class="n">result</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">svc</span><span class="o">.</span><span class="n">GetParameter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ssm</span><span class="o">.</span><span class="n">GetParameterInput</span><span class="p">{</span>
		<span class="n">Name</span><span class="o">:</span>           <span class="n">aws</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">parameter</span><span class="p">),</span>
		<span class="n">WithDecryption</span><span class="o">:</span> <span class="n">aws</span><span class="o">.</span><span class="n">Bool</span><span class="p">(</span><span class="no">false</span><span class="p">),</span>
	<span class="p">})</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="s">""</span><span class="p">,</span> <span class="n">err</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="n">cacheTime</span> <span class="o">&gt;</span> <span class="m">0</span> <span class="p">{</span>
		<span class="n">m</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="n">parameter</span><span class="p">,</span> <span class="o">*</span><span class="n">result</span><span class="o">.</span><span class="n">Parameter</span><span class="o">.</span><span class="n">Value</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">Second</span><span class="o">*</span><span class="n">time</span><span class="o">.</span><span class="n">Duration</span><span class="p">(</span><span class="n">cacheTime</span><span class="p">))</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Sprint</span><span class="p">(</span><span class="o">*</span><span class="n">result</span><span class="o">.</span><span class="n">Parameter</span><span class="o">.</span><span class="n">Value</span><span class="p">),</span> <span class="no">nil</span>
<span class="p">}</span>

</pre></td></tr></tbody></table></code></pre></div></div>

<p>E voltando para a parte de infraestrutura que anda junto com esse tipo de lógica, no nosso workload hipotético vamos salvar o valor da variável state do Terraform no Parameter Store, e com base nessa informação vamos desenvolver nossos fluxos, com base que se essa variável for trocada, no deploy em sequencia todas as aplicações sejam informadas quase que automaticamente de como elas devem se comportar.</p>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="nx">variable</span> <span class="s2">"state"</span> <span class="p">{</span>
  <span class="nx">type</span> <span class="p">=</span> <span class="nx">map</span><span class="p">(</span><span class="nx">any</span><span class="p">)</span>
  <span class="nx">default</span> <span class="p">=</span> <span class="p">{</span>
    <span class="s2">"sa-east-1"</span> <span class="err">:</span> <span class="s2">"ACTIVE"</span><span class="p">,</span>
    <span class="s2">"us-east-1"</span> <span class="err">:</span> <span class="s2">"PASSIVE"</span><span class="p">,</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Com base nisso vamos duplicar também o parâmeter store nas duas regiões utilizando o mesmo&nbsp;nome.</p>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="rouge-code"><pre><span class="nx">module</span> <span class="s2">"ssm_parameter_state_sa_east_1"</span> <span class="p">{</span>
  <span class="nx">source</span> <span class="p">=</span> <span class="s2">"./modules/parameter_store"</span>

  <span class="nx">providers</span> <span class="p">=</span> <span class="p">{</span>
    <span class="nx">aws</span> <span class="p">=</span> <span class="nx">aws</span><span class="p">.</span><span class="nx">primary</span>
  <span class="p">}</span>

  <span class="nx">name</span>  <span class="p">=</span> <span class="nx">format</span><span class="p">(</span><span class="s2">"/%s/site/state"</span><span class="p">,</span> <span class="nx">var</span><span class="p">.</span><span class="nx">project_name</span><span class="p">)</span>
  <span class="nx">value</span> <span class="p">=</span> <span class="nx">lookup</span><span class="p">(</span><span class="nx">var</span><span class="p">.</span><span class="nx">state</span><span class="p">,</span> <span class="s2">"sa-east-1"</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">module</span> <span class="s2">"ssm_parameter_state_us_east_1"</span> <span class="p">{</span>
  <span class="nx">source</span> <span class="p">=</span> <span class="s2">"./modules/parameter_store"</span>

  <span class="nx">providers</span> <span class="p">=</span> <span class="p">{</span>
    <span class="nx">aws</span> <span class="p">=</span> <span class="nx">aws</span><span class="p">.</span><span class="nx">disaster-recovery</span>
  <span class="p">}</span>

  <span class="nx">name</span>  <span class="p">=</span> <span class="nx">format</span><span class="p">(</span><span class="s2">"/%s/site/state"</span><span class="p">,</span> <span class="nx">var</span><span class="p">.</span><span class="nx">project_name</span><span class="p">)</span>
  <span class="nx">value</span> <span class="p">=</span> <span class="nx">lookup</span><span class="p">(</span><span class="nx">var</span><span class="p">.</span><span class="nx">state</span><span class="p">,</span> <span class="s2">"us-east-1"</span><span class="p">)</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Podemos conferir via painel o resultado das duas operações, tanto na <strong><em>Região Primária (sa-east-1)</em></strong> quanto na de <strong><em>Disaster Recovery (us-east-1)</em></strong>.</p>

<p><img src="https://cdn-images-1.medium.com/max/1024/1*vGEkN7JZqrRBqFQYOrfMkg.png" alt="Image 1"></p>

<p><img src="https://cdn-images-1.medium.com/max/1024/1*B8nW12m7RBZFhfW86NAMFw.png" alt="Image 2"></p>

<p>Trabalhando dessa forma, podemos recuperar nosso estado no início de um fluxo e trabalhá-lo até o final do mesmo, fazendo sempre uma validação do estado para saber se precisamos trabalhar o registro ou não. Detalharemos isso no próximo passo.</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre> <span class="k">if</span> <span class="n">state</span> <span class="o">!=</span> <span class="s">"ACTIVE"</span> <span class="p">{</span>
  <span class="k">return</span> <span class="no">nil</span>
 <span class="p">}</span>
 <span class="n">continueOqueEstavaFazendo</span><span class="p">()</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><br></p>

<h2 id="42--dry-run-processamento-café-com-leite">4.2 — Dry-Run, processamento café com leite</h2>

<p><strong>Dry-Run</strong>, também conhecido como teste simulado ou simulação de execução, é uma prática comum no desenvolvimento de software e testes. <strong>Consiste em executar um programa, algoritmo ou conjunto de instruções em um ambiente simulado, sem a efetiva execução das ações ou operações previstas</strong>.</p>

<p>Durante um Dry-Run, o código é analisado e executado passo a passo, e os resultados são simulados <strong>sem realizar alterações no estado real do sistema ou afetar os dados existentes</strong>. O objetivo principal é identificar erros, validar a lógica do programa e verificar a saída esperada, tudo isso sem impactar o ambiente de produção ou introduzir mudanças irreversíveis. Para essa arquitetura, vamos sair da definição da literatura e fazer com que o princípio do Dry-Run simplesmente não cometa nenhuma alteração, mesmo que consuma as mensagens e instruções com base no estado do feature toggle.</p>

<p>No nosso Workload hipotético, após a API Rest salvar a venda no DynamoDB, ela publica uma mensagem no tópico do SNS e o mesmo envia para o SQS em ambas as regiões. Essa mensagem deveria ser consumida pelos workers de ambas as regiões, e esses workers devem fazer um processamento falso, atualizar a flag de processado na tabela do DynamoDB e salvar o item no S3 conforme já explicado.</p>

<p>Por mais que a mensagem seja replicada em ambas as regiões, é um desperdício de dinheiro e poder computacional literalmente processar a mensagem duas vezes. Para isso, vamos utilizar o Feature Toggle do estado da Região para dizer para o nosso worker se ele deve processar a mensagem de fato ou executar um Dry-Run na mesma, ou simplesmente descartá-la e esperar que o processamento seja realizado e replicado para ela pela região ativa.</p>

<p><strong>Um exemplo de um processamento de Feature Flag e Dry-Run</strong></p>

<p><img src="https://cdn-images-1.medium.com/max/632/1*bnkjg7AajKq_ETm9u6TWXA.png" alt="Image 3"></p>

<p>Basicamente, de tempos em tempos atualizamos o estado do nosso runtime com o definido no Parameter Store e com base nesse estado, checamos se o Site/Região está ativo ou passivo. Caso esteja com o estado ACTIVE, executa o processamento em N ações descritas anteriormente, e caso esteja PASSIVE, executa o Dry-Run, remove a mensagem da fila em seguida.</p>

<p><strong>Exemplo do comportamento do Worker quando a região está ativa</strong></p>

<p><img src="https://cdn-images-1.medium.com/max/1024/1*UHiK-qqGyVn7vpdBHVHHEA.png" alt="Image 4"></p>

<p><strong>Exemplo do comportamento do Worker quando a região está passiva</strong></p>

<p><img src="https://cdn-images-1.medium.com/max/1024/1*Xapi6pv-tTzPOpEXYZUAWQ.png" alt="Image 5"></p>

<p><br></p>

<h2 id="43--idempotência">4.3 — Idempotência</h2>

<p>Talvez o padrão arquitetônico mais importante quando falamos de qualquer coisa que se propõe a ser resiliente e distribuída.</p>

<p>Na arquitetura de software, a <strong>idempotência</strong> é um conceito importante que descreve a propriedade de uma operação ou função que pode ser aplicada repetidamente sem alterar o resultado além da primeira aplicação. <strong>Em outras palavras, uma operação idempotente produz o mesmo resultado, independentemente do número de vezes que é executada.</strong></p>

<p><strong>A idempotência é uma característica desejável em sistemas distribuídos e transações de software, pois garante que a reexecução de uma operação não resulte em efeitos colaterais indesejados ou em um estado inconsistente do sistema.</strong> Isso é particularmente <strong>importante quando ocorrem falhas de rede, erros transientes ou reexecuções automáticas devido a mecanismos de recuperação de erros.</strong></p>

<p>Existem várias formas de estender a capacidade de um padrão de idempotência. Alguns exemplos fora desse assunto de Disaster Recovery que são naturalmente idempotentes:</p>

<ul>
  <li><strong>Operações de Atualização de Estado:</strong> Em APIs REST, as operações de atualização de estado geralmente seguem o princípio da idempotência. Por exemplo, se uma requisição <strong>DELETE</strong>, <strong>PUT</strong> ou <strong>PATCH</strong> for repetida várias vezes, o estado final do recurso será o mesmo.</li>
  <li><strong>Operações de Pagamento na Indústria Financeira:</strong> Em sistemas de pagamentos online, as transações de pagamento são <strong>geralmente</strong> idempotentes. Isso significa que, se uma transação de pagamento for repetida devido a um problema de comunicação ou a uma resposta de confirmação perdida, ela não resultará em cobranças duplicadas ao usuário.</li>
</ul>

<p>Porém, nesse exemplo, iremos implementar uma idempotência pragmática com base no ID único gerado ao longo de cada venda criada através da nossa API. Nesse caso, iremos controlar a idempotência garantindo um certo tempo de replicação dos recursos em uma tabela do <strong>DynamoDB</strong> exclusivamente preparada para isso.</p>

<p>O objetivo desse processo de idempotência no nosso workload hipotético é evitar o reprocessamento de uma venda criada e disponibilizada para consumo durante uma virada ou uma possível duplicação de dados, ou tentativa de reprocessamento por algum outro mecanismo não tratado aqui.</p>

<p><strong>Exemplo do fluxo de Idempotência de Processamento</strong></p>

<p>Vamos estender o diagrama que vimos no Dry-Run. Nesse caso, após validarmos que estamos numa região ativa, chegamos na tabela do DynamoDB de idempotência procurando pelo ID da venda. Caso ela já tenha sido processada, descartamos a mensagem. Caso o ID ainda não esteja presente na tabela, realizamos todos os fluxos de processamento que tratamos aqui e no final salvamos o mesmo na tabela de idempotência, também rodando como Global Table.</p>

<p><img src="https://cdn-images-1.medium.com/max/1024/1*wpM3_J8cbgi5DNxEjf1QwA.png" alt="Image 6"></p>

<p><strong>Por exemplo:</strong></p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre> <span class="n">idempotency</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">dao</span><span class="o">.</span><span class="n">CheckIdempotency</span><span class="p">(</span><span class="n">sale</span><span class="o">.</span><span class="n">ID</span><span class="p">)</span>
 <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">err</span>
 <span class="p">}</span>

 <span class="k">if</span> <span class="n">idempotency</span> <span class="p">{</span>
  <span class="n">log</span><span class="o">.</span><span class="n">Info</span><span class="p">()</span><span class="o">.</span>
   <span class="n">Str</span><span class="p">(</span><span class="s">"Region"</span><span class="p">,</span> <span class="n">aws_region</span><span class="p">)</span><span class="o">.</span>
   <span class="n">Str</span><span class="p">(</span><span class="s">"State"</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span><span class="o">.</span>
   <span class="n">Int</span><span class="p">(</span><span class="s">"Thread"</span><span class="p">,</span> <span class="n">thread</span><span class="p">)</span><span class="o">.</span>
   <span class="n">Str</span><span class="p">(</span><span class="s">"Sale"</span><span class="p">,</span> <span class="n">sale</span><span class="o">.</span><span class="n">ID</span><span class="p">)</span><span class="o">.</span>
   <span class="n">Msg</span><span class="p">(</span><span class="s">"Sale already processed, item found in idempotency table"</span><span class="p">)</span>
  <span class="k">return</span> <span class="no">nil</span>
 <span class="p">}</span>

<span class="c">// Continua </span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><br></p>

<h1 id="parte-5-testando-o-fluxo-de-disaster-recovery">Parte 5: Testando o Fluxo de Disaster Recovery</h1>

<p>Agora chegou a parte legal. Fizemos muitos desenhos bonitinhos, módulos lindos, explicamos um monte de paradigmas arquiteturais filosóficos, e agora precisamos validar de fato o funcionamento desse exemplo.</p>

<p>Vamos injetar carga utilizando o k6, uma ferramenta já conhecida de outros carnavais aqui no Medium. Injetaremos carga e monitoraremos o comportamento dos recursos das duas regiões via CloudWatch.</p>

<p><img src="https://cdn-images-1.medium.com/max/1024/1*3OYQWKmxq39Zcy5u58uRAA.png" alt="Imagem de Monitoramento"></p>

<p>A ideia é fazer todo o espelhamento e chaveamento via Terraform. Então vamos estruturar essa parte com base em passos de formiga, exemplificando ação e reação do workload.</p>

<h4 id="51--status-inicial">5.1 — Status Inicial</h4>

<p><img src="https://cdn-images-1.medium.com/max/1024/1*JhMiaPUbSWRGqKiaYOPCrA.png" alt="Imagem Status Inicial 1"></p>

<p><img src="https://cdn-images-1.medium.com/max/1024/1*eT_Y2v1y2SXZHm48SK9yxA.png" alt="Imagem Status Inicial 2"></p>

<p>Inicialmente, temos o workload atendendo e performando de forma prevista, somente na zona primária. Temos um contador de eventos de vendas e de requests por minuto no API Gateway para ambas as regiões.</p>

<p>Em paralelo, temos o registro de replicação das nossas tabelas do DynamoDB. Como estamos escrevendo e lendo da tabela na região primária (sa-east-1), devemos ver o fluxo de replicação indo para a região de DR (us-east-1).</p>

<p>Resumindo, nosso estado de configuração do chaveamento no Terraform está da seguinte forma: chaveando 100% do tráfego para São Paulo e mantendo nosso feature toggle em ACTIVE para o mesmo.</p>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="nx">variable</span> <span class="s2">"state"</span> <span class="p">{</span>
  <span class="nx">type</span> <span class="p">=</span> <span class="nx">map</span><span class="p">(</span><span class="nx">any</span><span class="p">)</span>
  <span class="nx">default</span> <span class="p">=</span> <span class="p">{</span>
    <span class="s2">"sa-east-1"</span> <span class="err">:</span> <span class="s2">"ACTIVE"</span><span class="p">,</span>
    <span class="s2">"us-east-1"</span> <span class="err">:</span> <span class="s2">"PASSIVE"</span><span class="p">,</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn-images-1.medium.com/max/1024/1*3aMUSS24hMBHNTt55TSIpw.png" alt="Imagem Status Inicial 3"></p>

<p><br></p>

<h2 id="52chaveando-odr">5.2 — Chaveando o&nbsp;DR</h2>

<p>Vamos alterar o estado no Terraform para desligar a zona de São Paulo e direcionar o tráfego diretamente para a região de Virginia.</p>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="nx">variable</span> <span class="s2">"state"</span> <span class="p">{</span>
  <span class="nx">type</span> <span class="p">=</span> <span class="nx">map</span><span class="p">(</span><span class="nx">any</span><span class="p">)</span>
  <span class="nx">default</span> <span class="p">=</span> <span class="p">{</span>
    <span class="s2">"sa-east-1"</span> <span class="err">:</span> <span class="s2">"PASSIVE"</span><span class="p">,</span>
    <span class="s2">"us-east-1"</span> <span class="err">:</span> <span class="s2">"ACTIVE"</span><span class="p">,</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Independente de onde e como você está executando isso, no fim essa mudança irá refletir com base em um&nbsp;apply</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>terraform apply <span class="nt">--auto-approve</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://cdn-images-1.medium.com/max/1024/1*NU7KjrRpy1qJhR9B5tKanA.png" alt="Imagem do Terraform Apply"></p>

<p><img src="https://cdn-images-1.medium.com/max/1024/1*58qBe9JSyvgduDX3byKY2A.png" alt="Imagem de Contabilização de Eventos"></p>

<p>Após aplicar as alterações com o Terraform, chaveando a Região primária para o DR sem interromper o teste de carga, podemos ver o início imediato da operação da região de DR, que começa a contabilizar eventos de vendas por ela iniciados, entrada de fluxo no API Gateway e a inversão do sentido de replicação das tabelas do <strong>DynamoDB</strong>.</p>

<p><img src="https://cdn-images-1.medium.com/max/1024/1*9YP2fX4lwsr1bTS5NrtJwg.png" alt="Imagem do Início de Operação da Região de DR"></p>

<p>Nesse cenário, começamos a utilizar os recursos da zona de DR como ACTIVE, enviando todo o tráfego da API para lá e desabilitando a zona primária em São Paulo, colocando-a como PASSIVE.</p>

<p>Acompanhamos também uma métrica de replicação das mensagens. Esse pode ser um bom indicador para o chaveamento de retorno para a Região Primária.</p>

<p><img src="https://cdn-images-1.medium.com/max/1024/1*e3jSpKphIZRtaw0oWaQRnA.png" alt="Imagem da Métrica de Replicação"></p>

<p><br></p>

<h1 id="parte-6-estratégias-adicionais">Parte 6: Estratégias Adicionais</h1>

<p>Como mencionado no início do artigo, algumas soluções e produtos da AWS projetados para Disaster Recovery foram desconsiderados durante a concepção deste texto. No entanto, vale a pena mencionar algumas das opções disponíveis.</p>

<p><br></p>

<h2 id="61--route53-failover">6.1 — Route53 Failover</h2>

<p>O Route53 Failover é um recurso que esteve perto de ser incluído, se não fosse pela parametrização de feature flag.</p>

<p>Usando o Route53 Failover, é possível redirecionar o tráfego de maneira inteligente entre várias regiões, assegurando que as solicitações dos usuários sejam redirecionadas para uma região de backup caso a primária fique indisponível. Isso é extremamente valioso em cenários de disaster recovery, onde manter a continuidade dos negócios é crítico.</p>

<p>O funcionamento do Route53 Failover <strong>é baseado em health checks</strong> configurados para monitorar a saúde das instâncias ou endpoints em cada região. Se um recurso falhar, o Route53 pode automaticamente redirecionar o tráfego para outra região que esteja operacional. <strong>Em caso de falha na região primária, o tráfego é redirecionado automaticamente para uma região secundária.</strong></p>

<p>A implementação desta estratégia é ideal para operações que possam funcionar de forma <strong>ATIVO/ATIVO</strong>, onde uma região pode gerenciar as solicitações de outra a qualquer momento.</p>

<p><img src="https://cdn-images-1.medium.com/max/912/0*zYsjTFq9nJY2CMx1.png" alt="Imagem Exemplo de Healthchecks do Route53"></p>

<p><strong>Exemplo da implementação em Terraform dos Healthchecks do Route53.</strong></p>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre><span class="nx">resource</span> <span class="s2">"aws_route53_health_check"</span> <span class="s2">"primary"</span> <span class="p">{</span>
  <span class="nx">fqdn</span>             <span class="p">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">api_gateway_dns_primary</span> 
  <span class="nx">port</span>             <span class="p">=</span> <span class="mi">443</span>
  <span class="nx">type</span>             <span class="p">=</span> <span class="s2">"HTTP"</span>  
  <span class="nx">resource_path</span>    <span class="p">=</span> <span class="s2">"/healthcheck"</span>  
  <span class="nx">request_interval</span> <span class="p">=</span> <span class="mi">30</span>  
  <span class="nx">failure_threshold</span> <span class="p">=</span> <span class="mi">3</span>  
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_route53_health_check"</span> <span class="s2">"secondary"</span> <span class="p">{</span>
  <span class="nx">fqdn</span>             <span class="p">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">api_gateway_dns_secondary</span>
  <span class="nx">port</span>             <span class="p">=</span> <span class="mi">443</span>
  <span class="nx">type</span>             <span class="p">=</span> <span class="s2">"HTTP"</span>
  <span class="nx">resource_path</span>    <span class="p">=</span> <span class="s2">"/healthcheck"</span>
  <span class="nx">request_interval</span> <span class="p">=</span> <span class="mi">30</span>
  <span class="nx">failure_threshold</span> <span class="p">=</span> <span class="mi">3</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre></td><td class="rouge-code"><pre><span class="nx">resource</span> <span class="s2">"aws_route53_record"</span> <span class="s2">"primary"</span> <span class="p">{</span>
  <span class="nx">zone_id</span> <span class="p">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">route53_hosted_zone</span>

  <span class="nx">name</span>    <span class="p">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">api_gateway_domain</span>
  <span class="nx">type</span>    <span class="p">=</span> <span class="s2">"A"</span>
  <span class="nx">ttl</span>     <span class="p">=</span> <span class="mi">60</span>  

  <span class="nx">failover_routing_policy</span> <span class="p">{</span>
    <span class="nx">type</span>         <span class="p">=</span> <span class="s2">"PRIMARY"</span>   <span class="c1"># Identificando que e o Registro Primário</span>
    <span class="nx">ttl_override</span> <span class="p">=</span> <span class="mi">60</span>  
  <span class="p">}</span>

  <span class="nx">set_identifier</span> <span class="p">=</span> <span class="s2">"primary"</span>
  <span class="nx">health_check_id</span> <span class="p">=</span> <span class="nx">aws_route53_health_check</span><span class="p">.</span><span class="nx">primary</span><span class="p">.</span><span class="nx">id</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_route53_record"</span> <span class="s2">"secondary"</span> <span class="p">{</span>
  <span class="nx">zone_id</span> <span class="p">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">route53_hosted_zone</span>

  <span class="nx">name</span>    <span class="p">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">api_gateway_domain</span>
  <span class="nx">type</span>    <span class="p">=</span> <span class="s2">"A"</span>
  <span class="nx">ttl</span>     <span class="p">=</span> <span class="mi">60</span>

  <span class="nx">failover_routing_policy</span> <span class="p">{</span>
    <span class="nx">type</span>         <span class="p">=</span> <span class="s2">"SECONDARY"</span>  <span class="c1"># Identificando que e o Registro Secundário</span>
    <span class="nx">ttl_override</span> <span class="p">=</span> <span class="mi">60</span>
  <span class="p">}</span>

  <span class="nx">set_identifier</span> <span class="p">=</span> <span class="s2">"secondary"</span>
  <span class="nx">health_check_id</span> <span class="p">=</span> <span class="nx">aws_route53_health_check</span><span class="p">.</span><span class="nx">secondary</span><span class="p">.</span><span class="nx">id</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="jekyll-linkpreview-wrapper">
  <div class="jekyll-linkpreview-wrapper-inner">
    <div class="jekyll-linkpreview-content">

      <div class="jekyll-linkpreview-body">
        <h2 class="jekyll-linkpreview-title">
          <a href="https://docs.aws.amazon.com/pt_br/Route53/latest/DeveloperGuide/dns-failover-configuring.html" target="_blank">Configurar failover de DNS - Amazon Route&nbsp;53</a>
        </h2>
        <div class="jekyll-linkpreview-description">Quando houver mais de um recurso executando a mesma função, (por exemplo, mais de um servidor HTTP ou servidor de e-mail), você poderá configurar o Amazon Route 53 para verificar a integridade dos seus recursos e responder às consultas de DNS usando somente os recursos íntegros. Por exemplo, suponhamos que seu site, example.com, esteja hospedado em seis servidores distribuídos por três datacenters ao redor do mundo (dois servidores em cada). Você pode configurar o Route 53 para verificar a integridade desses servidores e responder às consultas de DNS de example.com usando somente os servidores atualmente considerados como íntegros.</div>
      </div>
    </div>
    <div class="jekyll-linkpreview-footer">
      <a href="//docs.aws.amazon.com" target="_blank">docs.aws.amazon.com</a>
    </div>
  </div>
</div>

<p><br></p>

<h2 id="62--elasticache-multi-region-com-global-datastores">6.2 — Elasticache Multi Region com Global Datastores</h2>

<p>O <strong>Global Datastore</strong> é um recurso do <strong>Amazon ElastiCache</strong>, um serviço gerenciado de cache na nuvem da Amazon Web Services (AWS). Ele permite a replicação automática e síncrona de dados entre regiões geográficas distintas, proporcionando uma solução de cache altamente disponível e resiliente.</p>

<p>Configurar um Global Datastore significa criar um ambiente de cache que é distribuído em várias regiões da AWS. Isso beneficia aplicações ou serviços que operam em escala global, exigindo acesso rápido a dados em cache, não importando onde os usuários estão localizados.</p>

<p>Com o <strong>Global Datastore</strong>, o <strong>ElastiCache</strong> cuida da replicação dos dados em tempo real entre as regiões de forma automática, assegurando que os dados estejam sempre atualizados e acessíveis em todos os locais.</p>

<p>Este recurso não foi incluído no artigo pois os replication groups não suportam escrita bilateral nos clusters de replicação de outras regiões, apenas permitindo promoção automática em caso de failover provocado por uma falha no primário.</p>

<p><img src="https://cdn-images-1.medium.com/max/853/0*Vt66WYnI-GAwXVGT.png" alt="Imagem de Implementação em Terraform"></p>

<p><strong>Exemplo de Implementação em Terraform</strong></p>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
</pre></td><td class="rouge-code"><pre><span class="nx">resource</span> <span class="s2">"aws_elasticache_global_replication_group"</span> <span class="s2">"main"</span> <span class="p">{</span>

  <span class="nx">providers</span> <span class="p">=</span> <span class="p">{</span>
    <span class="nx">aws</span> <span class="p">=</span> <span class="nx">aws</span><span class="p">.</span><span class="nx">primary</span>
  <span class="p">}</span>

  <span class="nx">global_replication_group_id_suffix</span> <span class="p">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">project_name</span>
  <span class="nx">primary_replication_group_id</span>       <span class="p">=</span> <span class="nx">aws_elasticache_replication_group</span><span class="p">.</span><span class="nx">primary</span><span class="p">.</span><span class="nx">id</span>

  <span class="nx">engine_version</span> <span class="p">=</span> <span class="s2">"6.2"</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_elasticache_replication_group"</span> <span class="s2">"primary"</span> <span class="p">{</span>

  <span class="nx">providers</span> <span class="p">=</span> <span class="p">{</span>
    <span class="nx">aws</span> <span class="p">=</span> <span class="nx">aws</span><span class="p">.</span><span class="nx">primary</span>
  <span class="p">}</span>

  <span class="nx">replication_group_id</span> <span class="p">=</span> <span class="s2">"${var.project_name}-primary"</span>
  <span class="nx">description</span>          <span class="p">=</span> <span class="s2">"primary replication group"</span>

  <span class="nx">engine</span>         <span class="p">=</span> <span class="s2">"redis"</span>
  <span class="nx">engine_version</span> <span class="p">=</span> <span class="s2">"6.0"</span>
  <span class="nx">node_type</span>      <span class="p">=</span> <span class="s2">"cache.m5.large"</span>

  <span class="nx">num_cache_clusters</span> <span class="p">=</span> <span class="mi">1</span>

  <span class="nx">lifecycle</span> <span class="p">{</span>
    <span class="nx">ignore_changes</span> <span class="p">=</span> <span class="p">[</span><span class="nx">engine_version</span><span class="p">]</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_elasticache_replication_group"</span> <span class="s2">"secondary"</span> <span class="p">{</span>
  <span class="nx">providers</span> <span class="p">=</span> <span class="p">{</span>
    <span class="nx">aws</span> <span class="p">=</span> <span class="nx">aws</span><span class="p">.</span><span class="nx">disaster-recovery</span>
  <span class="p">}</span>

  <span class="nx">replication_group_id</span>        <span class="p">=</span> <span class="s2">"${var.project_name}-secondary"</span>
  <span class="nx">description</span>                 <span class="p">=</span> <span class="s2">"secondary replication group"</span>
  <span class="nx">global_replication_group_id</span> <span class="p">=</span> <span class="nx">aws_elasticache_global_replication_group</span><span class="p">.</span><span class="nx">example</span><span class="p">.</span><span class="nx">global_replication_group_id</span>

  <span class="nx">num_cache_clusters</span> <span class="p">=</span> <span class="mi">1</span>

  <span class="nx">lifecycle</span> <span class="p">{</span>
    <span class="nx">ignore_changes</span> <span class="p">=</span> <span class="p">[</span><span class="nx">engine_version</span><span class="p">]</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="jekyll-linkpreview-wrapper">
  <div class="jekyll-linkpreview-wrapper-inner">
    <div class="jekyll-linkpreview-content">

      <div class="jekyll-linkpreview-body">
        <h2 class="jekyll-linkpreview-title">
          <a href="https://docs.aws.amazon.com/AmazonElastiCache/latest/red-ug/Redis-Global-Datastore.html" target="_blank">Replication across AWS Regions using global datastores - Amazon ElastiCache for Redis</a>
        </h2>
        <div class="jekyll-linkpreview-description">Replicate data across AWS Regions using the Global Datastore feature in Amazon ElastiCache for Redis.</div>
      </div>
    </div>
    <div class="jekyll-linkpreview-footer">
      <a href="//docs.aws.amazon.com" target="_blank">docs.aws.amazon.com</a>
    </div>
  </div>
</div>

<p><br></p>

<h2 id="63--rds-cross-region-read-replicas">6.3 — RDS Cross Region Read Replicas</h2>

<p>O <strong>Cross-Region Read Replicas</strong> do <strong>Amazon RDS (Relational Database Service)</strong> é um recurso que permite replicar dados de um banco de dados em uma região para outras regiões. Isso melhora a disponibilidade, desempenho e resiliência de bancos de dados globais.</p>

<p>Ao usar Cross-Region Read Replicas, você pode criar cópias de leitura do seu banco de dados em regiões distantes, que são úteis para consultas intensivas, carga distribuída e redução de latência.</p>

<p>O recurso é limitado a operações de leitura, não permitindo escritas bilaterais.</p>

<div class="jekyll-linkpreview-wrapper">
  <div class="jekyll-linkpreview-wrapper-inner">
    <div class="jekyll-linkpreview-content">

      <div class="jekyll-linkpreview-body">
        <h2 class="jekyll-linkpreview-title">
          <a href="https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/Concepts.RDS_Fea_Regions_DB-eng.Feature.CrossRegionReadReplicas.html" target="_blank">Cross-Region read replicas - Amazon Relational Database Service</a>
        </h2>
        <div class="jekyll-linkpreview-description">View the AWS Region and Amazon RDS DB engine version support for the cross-region read replicas feature.</div>
      </div>
    </div>
    <div class="jekyll-linkpreview-footer">
      <a href="//docs.aws.amazon.com" target="_blank">docs.aws.amazon.com</a>
    </div>
  </div>
</div>

<p><br></p>

<h2 id="64--aurora-global-database">6.4 — Aurora Global Database</h2>

<p>O <strong>Aurora Global Database</strong> é um recurso do Amazon Aurora, compatível com MySQL e PostgreSQL. Permite a criação de um ambiente de banco de dados com replicação automática entre múltiplas regiões.</p>

<p>Você pode criar um cluster primário e replicar dados para até cinco regiões secundárias. As secundárias são leitura ou requerem intervenção manual para outros usos, o que também limitou sua inclusão neste artigo.</p>

<p><img src="https://cdn-images-1.medium.com/max/756/0*JDCfJJk2o8N7OSzZ.png" alt="Imagem de Aurora Global Database"></p>

<div class="jekyll-linkpreview-wrapper">
  <div class="jekyll-linkpreview-wrapper-inner">
    <div class="jekyll-linkpreview-content">

      <div class="jekyll-linkpreview-body">
        <h2 class="jekyll-linkpreview-title">
          <a href="https://docs.aws.amazon.com/AmazonRDS/latest/AuroraUserGuide/aurora-global-database.html" target="_blank">Using Amazon Aurora global databases - Amazon Aurora</a>
        </h2>
        <div class="jekyll-linkpreview-description">Learn how to create and work with Amazon Aurora global databases. An Aurora global database is made up of multiple Aurora DB clusters in different AWS Regions. The result is low-latency global reads and disaster recovery if an AWS Region experiences an outage.</div>
      </div>
    </div>
    <div class="jekyll-linkpreview-footer">
      <a href="//docs.aws.amazon.com" target="_blank">docs.aws.amazon.com</a>
    </div>
  </div>
</div>

<p><br></p>

<h2 id="65--secrets-manager-multi-region-replication">6.5 — Secrets Manager Multi-Region Replication</h2>

<p>A <strong>replicação Multi-Region do Secrets Manager</strong> permite replicar secrets para regiões adicionais para DR, conformidade ou baixa latência.</p>

<p>A replicação é automática: atualizações em uma região primária são replicadas para todas as secundárias. Não foi considerado para o artigo por não ter uso em contextos não relacionados à gestão de segredos e por ainda não estar disponível para Terraform.</p>

<div class="jekyll-linkpreview-wrapper">
  <div class="jekyll-linkpreview-wrapper-inner">
    <div class="jekyll-linkpreview-content">
      <div class="jekyll-linkpreview-image">
        <a href="https://aws.amazon.com/blogs/security/how-to-replicate-secrets-aws-secrets-manager-multiple-regions/" target="_blank">
          <img src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2021/02/28/Replicate-AWS-Secrets-Manager-2021-ForSocial.jpg">
        </a>
      </div>

      <div class="jekyll-linkpreview-body">
        <h2 class="jekyll-linkpreview-title">
          <a href="https://aws.amazon.com/blogs/security/how-to-replicate-secrets-aws-secrets-manager-multiple-regions/" target="_blank">How to replicate secrets in AWS Secrets Manager to multiple Regions | Amazon Web Services</a>
        </h2>
        <div class="jekyll-linkpreview-description">On March 3, 2021, we launched a new feature for AWS Secrets Manager that makes it possible for you to replicate secrets across multiple AWS Regions. You can give your multi-Region applications access to replicated secrets in the required Regions and rely on Secrets Manager to keep the replicas in sync with the primary secret. […]</div>
      </div>
    </div>
    <div class="jekyll-linkpreview-footer">
      <a href="//aws.amazon.com" target="_blank">aws.amazon.com</a>
    </div>
  </div>
</div>

<p><br></p>

<h2 id="66--mirror-maker-e-msk">6.6 — Mirror Maker e MSK</h2>

<p>O Mirror Maker é uma ferramenta do Amazon Managed Streaming for Apache Kafka (MSK), que permite replicar tópicos e partições de um cluster para outro.</p>

<p>O Mirror Maker replica dados do Kafka entre regiões, suportando DR, leitura de baixa latência e distribuição de carga.</p>

<p>Para replicar usando o Mirror Maker, é necessário configurar um link entre VPCs de diferentes regiões.</p>

<div class="jekyll-linkpreview-wrapper">
  <div class="jekyll-linkpreview-wrapper-inner">
    <div class="jekyll-linkpreview-content">

      <div class="jekyll-linkpreview-body">
        <h2 class="jekyll-linkpreview-title">
          <a href="https://docs.aws.amazon.com/msk/latest/developerguide/migration.html" target="_blank">Migrating to an Amazon MSK Cluster - Amazon Managed Streaming for Apache Kafka</a>
        </h2>
        <div class="jekyll-linkpreview-description">Use Apache Kafka's MirrorMaker to migrate your cluster.</div>
      </div>
    </div>
    <div class="jekyll-linkpreview-footer">
      <a href="//docs.aws.amazon.com" target="_blank">docs.aws.amazon.com</a>
    </div>
  </div>
</div>

<div class="jekyll-linkpreview-wrapper">
  <div class="jekyll-linkpreview-wrapper-inner">
    <div class="jekyll-linkpreview-content">

      <div class="jekyll-linkpreview-body">
        <h2 class="jekyll-linkpreview-title">
          <a href="https://www.instaclustr.com/support/documentation/kafka/kafka-cluster-operations/setting-up-mirror-maker/" target="_blank">Setting up Mirror Maker</a>
        </h2>
        <div class="jekyll-linkpreview-description">Tutorial to set up Kafka Mirror Maker. A feature in Kafka allowing maintaining a replica of a Kafka cluster in a separate data centre.</div>
      </div>
    </div>
    <div class="jekyll-linkpreview-footer">
      <a href="//www.instaclustr.com" target="_blank">www.instaclustr.com</a>
    </div>
  </div>
</div>

<p><br></p>

<h1 id="conclusão">Conclusão</h1>

<p>Minha conclusão é que esse artigo foi muito extenso e cansativo. E a porcentagem de pessoas que vão chegar até esse ponto deve ser muito baixa. Se você chegou até aqui, saiba que eu estou muito feliz, e por favor, me deixe saber disso. Esse foi de longe o artigo mais extenso e cansativo que eu já escrevi nos últimos anos, e espero de coração que ajude na firmação de conceitos e a pensar em estratégias paupáveis para o seu contexto depois de ver os exemplos daqui.</p>

<p>E um agradecimento de coração a todos os revisores que dedicaram seu tempo pra avaliar o artigo.</p>

<p><br></p>

<h4 id="repositórios-do-artigo">Repositórios do Artigo</h4>

<ul>
  <li><a href="https://github.com/msfidelis/aws-multi-region-disaster-recovery">GitHub - msfidelis/aws-multi-region-disaster-recovery: Example to explain how to implement minimal multi-region architecture on AWS with disaster recovery</a></li>
  <li><a href="https://github.com/msfidelis/aws-multi-region-disaster-recovery-apps">GitHub - msfidelis/aws-multi-region-disaster-recovery-apps: Apps to aws-multi-region-disaster-recovery example</a></li>
</ul>

<p><br></p>

<h4 id="links-e-referências">Links e Referências</h4>

<ul>
  <li><strong>Terraform — Global Replication Groups</strong> (<a href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/elasticache_global_replication_group">https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/elasticache_global_replication_group</a>)</li>
  <li><strong>Terraform – Lookup</strong> (https://developer.hashicorp.com/terraform/language/functions/lookup)</li>
  <li><strong>Terraform – Maps</strong>
(https://developer.hashicorp.com/terraform/language/expressions/types#maps-objects)</li>
  <li><strong>AWS Disaster Recovery Workshop</strong> (<a href="https://disaster-recovery.workshop.aws/en/">https://disaster-recovery.workshop.aws/en/</a>)</li>
  <li><strong>Creating Disaster Recovery Mechanisms Using Amazon Route 53</strong> (<a href="https://aws.amazon.com/blogs/networking-and-content-delivery/creating-disaster-recovery-mechanisms-using-amazon-route-53/">https://aws.amazon.com/blogs/networking-and-content-delivery/creating-disaster-recovery-mechanisms-using-amazon-route-53/</a>)</li>
  <li><strong>Resilience in Amazon Route53</strong> (<a href="https://docs.aws.amazon.com/Route53/latest/DeveloperGuide/disaster-recovery-resiliency.html">https://docs.aws.amazon.com/Route53/latest/DeveloperGuide/disaster-recovery-resiliency.html</a>)</li>
  <li><strong>Amazon DynamoDB Global Tables</strong> (<a href="https://aws.amazon.com/dynamodb/global-tables/">https://aws.amazon.com/dynamodb/global-tables/</a>)</li>
  <li><strong>AWS Disaster Recovery Strategies</strong> (<a href="https://xebia.com/blog/aws-disaster-recovery-strategies-poc-with-terraform/">https://xebia.com/blog/aws-disaster-recovery-strategies-poc-with-terraform/</a>)</li>
  <li><strong>How To Build a Custom Disaster Recovery Process for AWS Applications</strong> (<a href="https://www.encora.com/insights/how-to-build-a-custom-disaster-recovery-process-for-aws-applications">https://www.encora.com/insights/how-to-build-a-custom-disaster-recovery-process-for-aws-applications</a>)</li>
  <li><strong>Google Disaster recovery planning guide</strong> (<a href="https://cloud.google.com/architecture/dr-scenarios-planning-guide">https://cloud.google.com/architecture/dr-scenarios-planning-guide</a>)</li>
  <li><strong>Disaster Recovery for Multi-Region Kafka at Uber</strong> (<a href="https://www.uber.com/en-KW/blog/kafka/">https://www.uber.com/en-KW/blog/kafka/</a>)</li>
</ul>

<p><br></p>

<h4 id="obrigado-aos-revisores">Obrigado aos Revisores</h4>

<ul>
  <li><a href="https://twitter.com/raffasarts">Rafael - (@ raffasarts)</a></li>
  <li><a href="https://twitter.com/caiodelgadonew">Caio Delgado — (@ caiodelgadonew)</a></li>
  <li><a href="https://twitter.com/indiepagodeiro">Bernardo — (@ indiepagodeiro)</a></li>
  <li><a href="https://twitter.com/kalves_rohan">Kaleb — (@ kalves_rohan)</a></li>
  <li><a href="https://twitter.com/lhgaravatti">Luis Garavatti — (@ lhgaravatti)</a></li>
  <li><a href="https://twitter.com/luiz_aoqui">Luiz Aoqui – (@ luiz_aoqui)</a></li>
</ul>

<p><a href="https://twitter.com/fidelissauro"><strong>Me sigam no Twitter para acompanhar as paradinhas que eu compartilho por lá!</strong></a></p>

<p>Te ajudei de alguma forma? Me pague um café (Mentira, todos os valores doados nessa chave são dobrados por mim e destinados a ongs de apoio e resgate animal</p>

<p><strong>Chave Pix:</strong> fe60fe92-ecba-4165-be5a-3dccf8a06bfc</p>

            </div>

            <!-- Rating -->
            

            <!-- Post Date -->
            <p>
            <small>
                <span class="post-date"><time class="post-date" datetime="2023-07-15">15 Jul 2023</time></span>           
                
                </small>
            </p>

            <!-- Post Categories -->
            <div class="after-post-cats">
                <ul class="tags mb-4">
                    
                    
                    <li>
                        <a class="smoothscroll" href="/categories#arquitetura">arquitetura</a>
                    </li>
                    
                    <li>
                        <a class="smoothscroll" href="/categories#aws">aws</a>
                    </li>
                    
                    <li>
                        <a class="smoothscroll" href="/categories#disaster-recovery">disaster-recovery</a>
                    </li>
                    
                    <li>
                        <a class="smoothscroll" href="/categories#terraform">terraform</a>
                    </li>
                    
                </ul>
            </div>
            <!-- End Categories -->

            <!-- Post Tags -->
            <div class="after-post-tags">
                <ul class="tags">
                    
                    
                </ul>
            </div>
            <!-- End Tags -->

            <!-- Prev/Next -->
            <div class="row PageNavigation d-flex justify-content-between font-weight-bold">
            
            <a class="prev d-block col-md-6" href="//argo-rollouts-qual-a-forma-mais-simples-de-executar-canary-releases-e-blue-green-deployments-no/"> &laquo; Argo-Rollouts — "Qual a forma mais simples de executar Canary Releases e Blue/Green Deployments no Kubernetes?"</a>
            
            
            <a class="next d-block col-md-6 text-lg-right" href="//keda-autoscaler-scale-per-tps/">Keda Autoscaler - Escalando sua aplicação por requests HTTP usando métricas do Prometheus &raquo; </a>
            
            <div class="clearfix"></div>
            </div>
            <!-- End Categories -->

        </div>
        <!-- End Post -->

    </div>
</div>
<!-- End Article
================================================== -->

<!-- Begin Comments
================================================== -->

    <div class="container">
        <div id="comments" class="row justify-content-center mb-5">
            <div class="col-md-8">
                <section class="disqus">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = ''; 
        var disqus_developer = 0;
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = window.location.protocol + '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>

            </div>
        </div>
    </div>

<!--End Comments
================================================== -->

<!-- Review with LD-JSON, adapt it for your needs if you like, but make sure you test the generated HTML source code first: 
https://search.google.com/structured-data/testing-tool/u/0/
================================================== -->

</div>

<!-- 
<!-- Bottom Alert Bar
================================================== -->
<div class="alertbar">
	<div class="container text-center">
		<span><img src="/assets/images/logo.png" alt="Matheus Fidelis - Engineering Blog"> &nbsp; Never miss a <b>story</b> from us, subscribe to our newsletter</span>
        <form action="https://wowthemes.us11.list-manage.com/subscribe/post?u=8aeb20a530e124561927d3bd8&amp;id=8c3d2d214b" method="post" name="mc-embedded-subscribe-form" class="wj-contact-form validate" target="_blank" novalidate>
            <div class="mc-field-group">
            <input type="email" placeholder="Email" name="EMAIL" class="required email" id="mce-EMAIL" autocomplete="on" required>
            <input type="submit" value="Subscribe" name="subscribe" class="heart">
            </div>
        </form>
	</div>
</div>
 -->
    
</div>

<!-- Categories Jumbotron
================================================== -->
<div class="jumbotron fortags">
	<div class="d-md-flex h-100">
		<div class="col-md-4 transpdark align-self-center text-center h-100">
            <div class="d-md-flex align-items-center justify-content-center h-100">
                <h2 class="d-md-block align-self-center py-1 font-weight-light">Explore <span class="d-none d-md-inline">→</span></h2>
            </div>
		</div>
		<div class="col-md-8 p-5 align-self-center text-center">
            
            
                
                    <a class="mt-1 mb-1" href="/categories#kubernetes">kubernetes (5)</a>
                
                    <a class="mt-1 mb-1" href="/categories#istio">istio (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#disaster-recovery">disaster-recovery (2)</a>
                
                    <a class="mt-1 mb-1" href="/categories#service-mesh">service-mesh (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#aws">aws (4)</a>
                
                    <a class="mt-1 mb-1" href="/categories#arquitetura">arquitetura (3)</a>
                
                    <a class="mt-1 mb-1" href="/categories#terraform">terraform (4)</a>
                
                    <a class="mt-1 mb-1" href="/categories#karpenter">karpenter (2)</a>
                
                    <a class="mt-1 mb-1" href="/categories#argo-rollouts">argo-rollouts (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#keda">keda (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#containers">containers (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#cloud-native">cloud-native (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#capacity">capacity (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#dicas">dicas (1)</a>
                
            
            
		</div>
	</div>
</div>

<!-- Begin Footer
================================================== -->
<footer class="footer">
    <div class="container">
        <div class="row">
            <div class="col-md-6 col-sm-6 text-center text-lg-left">
                Copyright © 2023 Matheus Fidelis 
            </div>
            <div class="col-md-6 col-sm-6 text-center text-lg-right">    
                <a target="_blank" href="https://www.wowthemes.net/mediumish-free-jekyll-template/">Mediumish Jekyll Theme</a> by WowThemes.net
            </div>
        </div>
    </div>
</footer>
<!-- End Footer
================================================== -->

</div> <!-- /.site-content -->

<!-- Scripts
================================================== -->

<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js" integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut" crossorigin="anonymous"></script>

<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js" integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k" crossorigin="anonymous"></script>

<script src="/assets/js/mediumish.js"></script>


<script src="/assets/js/lazyload.js"></script>


<script src="/assets/js/ie10-viewport-bug-workaround.js"></script> 


<script id="dsq-count-scr" src="//.disqus.com/count.js"></script>



<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-4Z30K3KNFW"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-4Z30K3KNFW');
</script>



</body>
</html>
